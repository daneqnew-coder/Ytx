<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>يمنتكس برو · النظام الشامل لإدارة المصاعد</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Cairo', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #3b82f6; --primary-dark: #2563eb; --secondary: #8b5cf6;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #06b6d4;
      --dark: #0f172a; --light: #f8fafc; --surface: #ffffff;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    body { 
      background: linear-gradient(135deg, #f0f9ff 0%, #fef3c7 30%, #f0fdf4 70%, #fef3c7 100%); 
      min-height: 100vh; 
      color: #1e293b;
    }
    
    /* Glassmorphism Pro */
    .glass { 
      background: rgba(255, 255, 255, 0.92); 
      backdrop-filter: blur(16px); 
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: var(--shadow-lg);
      border-radius: 1.5rem;
    }
    .glass-dark { 
      background: rgba(15, 23, 42, 0.95); 
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: white;
    }
    .glass-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(248,250,252,0.95));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(226, 232, 240, 0.8);
      border-radius: 1.25rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glass-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: rgba(59, 130, 246, 0.4);
    }
    
    /* Animations Pro */
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .slide-up { animation: slideUp 0.5s ease-out forwards; }
    .scale-in { animation: scaleIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(24px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.85; transform: scale(1.02); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-float { animation: float 3s ease-in-out infinite; }
    
    /* Sidebar Pro */
    .sidebar-item { 
      display: flex; align-items: center; gap: 0.875rem; 
      padding: 0.875rem 1.25rem; border-radius: 0.875rem; 
      transition: all 0.2s ease; cursor: pointer; position: relative;
      font-weight: 500;
    }
    .sidebar-item:hover { 
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.12), transparent);
      transform: translateX(4px);
    }
    .sidebar-item.active { 
      background: linear-gradient(90deg, rgba(59,130,246,0.18), rgba(139,92,246,0.08));
      color: var(--primary); font-weight: 700;
      box-shadow: inset 4px 0 0 var(--primary);
    }
    .sidebar-item .badge { 
      margin-right: auto; 
      background: rgba(59, 130, 246, 0.15); 
      color: var(--primary);
    }
    
    /* Badges & Status Pro */
    .badge { 
      display: inline-flex; align-items: center; gap: 0.375rem;
      padding: 0.25rem 0.75rem; border-radius: 9999px; 
      font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    .badge-online { background: rgba(16, 185, 129, 0.12); color: #047857; border: 1px solid rgba(16, 185, 129, 0.25); }
    .badge-maintenance { background: rgba(245, 158, 11, 0.12); color: #b45309; border: 1px solid rgba(245, 158, 11, 0.25); }
    .badge-offline { background: rgba(107, 114, 128, 0.12); color: #4b5563; border: 1px solid rgba(107, 114, 128, 0.25); }
    .badge-emergency { 
      background: rgba(239, 68, 68, 0.15); color: #b91c1c; 
      border: 1px solid rgba(239, 68, 68, 0.3);
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
    }
    .badge-new { 
      background: linear-gradient(135deg, #8b5cf6, #ec4899); 
      color: white; 
      animation: pulse 2s infinite;
    }
    
    /* Progress Bars Pro */
    .progress { 
      height: 10px; background: #e2e8f0; border-radius: 9999px; 
      overflow: hidden; position: relative;
    }
    .progress::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    
    .progress-fill { 
      height: 100%; border-radius: 9999px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
      position: relative; overflow: hidden;
    }
    .progress-fill::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    .progress-fill.green { background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7); }
    .progress-fill.yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24, #fcd34d); }
    .progress-fill.red { background: linear-gradient(90deg, #ef4444, #f87171, #fca5a5); }
    .progress-fill.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa, #93c5fd); }
    .progress-fill.purple { background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd); }
    
    /* Forms Pro */
    .form-input {
      width: 100%; padding: 0.875rem 1.125rem; border-radius: 0.875rem;
      border: 2px solid #e2e8f0; background: white;
      transition: all 0.2s ease; font-size: 0.95rem;
      box-shadow: var(--shadow-sm);
    }
    .form-input:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), var(--shadow);
      transform: translateY(-1px);
    }
    .form-input:disabled {
      background: #f8fafc; color: #64748b; cursor: not-allowed;
    }
    .form-label { 
      display: block; font-weight: 600; margin-bottom: 0.5rem; 
      color: #334155; font-size: 0.9rem;
    }
    .form-label.required::after {
      content: ' *'; color: var(--danger); font-weight: 700;
    }
    .form-group { margin-bottom: 1.25rem; }
    .form-hint { 
      font-size: 0.8rem; color: #64748b; margin-top: 0.375rem;
      display: flex; align-items: center; gap: 0.375rem;
    }
    .form-hint i { color: var(--info); }
    
    /* Toggle Switch Pro */
    .toggle {
      position: relative; display: inline-block; width: 52px; height: 28px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; inset: 0;
      background-color: #cbd5e1; border-radius: 9999px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .toggle-slider::before {
      position: absolute; content: ""; height: 22px; width: 22px;
      left: 3px; bottom: 3px; background-color: white;
      border-radius: 50%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }
    input:checked + .toggle-slider { background: linear-gradient(135deg, var(--primary), var(--secondary)); }
    input:checked + .toggle-slider::before { transform: translateX(24px); }
    input:disabled + .toggle-slider { opacity: 0.5; cursor: not-allowed; }
    
    /* Tables Pro */
    .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .data-table th { 
      background: linear-gradient(180deg, #f8fafc, #f1f5f9); 
      padding: 1rem 1.25rem; text-align: right; 
      font-weight: 700; color: #475569; 
      border-bottom: 2px solid #e2e8f0;
      font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;
      position: sticky; top: 0; z-index: 10;
    }
    .data-table td { 
      padding: 1rem 1.25rem; border-bottom: 1px solid #f1f5f9; 
      vertical-align: middle; font-size: 0.95rem;
      transition: background 0.2s;
    }
    .data-table tbody tr { transition: all 0.2s; }
    .data-table tbody tr:hover { 
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.04), transparent);
      transform: translateX(4px);
    }
    .data-table tbody tr:last-child td { border-bottom: none; }
    
    /* Modals Pro */
    .modal { 
      position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); 
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      padding: 1rem; backdrop-filter: blur(8px);
    }
    .modal.active { opacity: 1; visibility: visible; }
    .modal-content { 
      background: white; border-radius: 1.75rem; 
      width: 100%; max-width: 900px; max-height: 92vh; 
      overflow-y: auto; box-shadow: var(--shadow-xl);
      transform: scale(0.94) translateY(12px); 
      transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid rgba(255,255,255,0.6);
    }
    .modal.active .modal-content { transform: scale(1) translateY(0); }
    .modal-header {
      padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0;
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(180deg, #f8fafc, white);
      position: sticky; top: 0; z-index: 20; border-radius: 1.75rem 1.75rem 0 0;
    }
    .modal-body { padding: 1.5rem 2rem; }
    .modal-footer {
      padding: 1.25rem 2rem; border-top: 1px solid #e2e8f0;
      display: flex; justify-content: flex-end; gap: 0.75rem;
      background: #f8fafc; position: sticky; bottom: 0; z-index: 20;
      border-radius: 0 0 1.75rem 1.75rem;
    }
    
    /* Wizard Steps Pro */
    .wizard-steps {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 2.5rem; position: relative;
    }
    .wizard-steps::before {
      content: ''; position: absolute; top: 20px; left: 5%; right: 5%;
      height: 3px; background: #e2e8f0; z-index: 1;
      border-radius: 9999px;
    }
    .wizard-step {
      display: flex; flex-direction: column; align-items: center;
      position: relative; z-index: 2; cursor: pointer;
      transition: all 0.3s;
    }
    .wizard-step-number {
      width: 40px; height: 40px; border-radius: 50%;
      background: #e2e8f0; display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: #64748b; border: 3px solid white;
      box-shadow: var(--shadow); transition: all 0.3s;
    }
    .wizard-step.active .wizard-step-number {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white; transform: scale(1.1);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25);
    }
    .wizard-step.completed .wizard-step-number {
      background: var(--success); color: white;
    }
    .wizard-step-label {
      margin-top: 0.5rem; font-size: 0.8rem; font-weight: 600;
      color: #64748b; text-align: center; max-width: 80px;
      transition: color 0.3s;
    }
    .wizard-step.active .wizard-step-label { color: var(--primary); }
    .wizard-step.completed .wizard-step-label { color: var(--success); }
    
    /* Catalog Cards Pro */
    .catalog-card {
      background: white; border-radius: 1.5rem; padding: 1.75rem;
      border: 2px solid #e2e8f0; cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative; overflow: hidden;
    }
    .catalog-card::before {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(59,130,246,0.08), transparent);
      opacity: 0; transition: opacity 0.3s;
    }
    .catalog-card:hover {
      border-color: var(--primary); transform: translateY(-6px);
      box-shadow: var(--shadow-xl);
    }
    .catalog-card:hover::before { opacity: 1; }
    .catalog-card.selected {
      border-color: var(--primary); background: linear-gradient(135deg, rgba(59,130,246,0.06), white);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), var(--shadow-lg);
    }
    .catalog-card.selected::after {
      content: '✓'; position: absolute; top: 1rem; left: 1rem;
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--success); color: white;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.9rem;
      box-shadow: var(--shadow);
    }
    .catalog-icon {
      width: 64px; height: 64px; border-radius: 1.25rem;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 1.25rem; font-size: 1.75rem;
      background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(139,92,246,0.12));
      color: var(--primary);
    }
    
    /* Device Scanner Pro */
    .device-scanner {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 1.5rem; padding: 2rem; color: white;
      position: relative; overflow: hidden;
    }
    .device-scanner::before {
      content: ''; position: absolute; inset: 0;
      background: radial-gradient(circle at 30% 30%, rgba(59,130,246,0.15), transparent 50%);
      pointer-events: none;
    }
    .scanner-animation {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    }
    .scanner-ring {
      position: absolute; width: 200px; height: 200px; border-radius: 50%;
      border: 2px solid rgba(59, 130, 246, 0.3);
      animation: scanPulse 2s infinite;
    }
    .scanner-ring:nth-child(2) { animation-delay: 0.5s; width: 280px; height: 280px; }
    .scanner-ring:nth-child(3) { animation-delay: 1s; width: 360px; height: 360px; }
    @keyframes scanPulse {
      0% { transform: scale(0.8); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 0.3; }
      100% { transform: scale(0.8); opacity: 0.8; }
    }
    .device-item {
      background: rgba(255,255,255,0.08); border-radius: 1rem;
      padding: 1rem; margin-bottom: 0.75rem; cursor: pointer;
      transition: all 0.2s; border: 1px solid transparent;
    }
    .device-item:hover {
      background: rgba(255,255,255,0.15); border-color: rgba(59,130,246,0.4);
      transform: translateX(4px);
    }
    .device-item.connected {
      background: rgba(16, 185, 129, 0.15); border-color: var(--success);
    }
    
    /* Notifications Pro */
    .notification { 
      position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: white; border-radius: 1.25rem; padding: 1rem 1.5rem;
      box-shadow: var(--shadow-xl); display: flex; align-items: center; gap: 0.875rem;
      z-index: 3000; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border-left: 5px solid var(--primary); min-width: 320px; max-width: 480px;
      border: 1px solid rgba(255,255,255,0.8);
    }
    .notification.show { transform: translateX(-50%) translateY(0); }
    .notification.success { border-left-color: var(--success); }
    .notification.warning { border-left-color: var(--warning); }
    .notification.error { border-left-color: var(--danger); }
    .notification.info { border-left-color: var(--info); }
    
    /* Responsive Pro */
    .sidebar-collapsed { width: 5rem !important; }
    .sidebar-collapsed .sidebar-text, 
    .sidebar-collapsed .sidebar-badge,
    .sidebar-collapsed .tenant-info span:not(:first-child) { display: none !important; }
    .sidebar-collapsed .sidebar-icon { margin: 0 auto !important; }
    
    @media (max-width: 1024px) {
      #sidebar { position: fixed; right: -100%; z-index: 100; transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
      #sidebar.active { right: 0; }
      #mainContent { margin-right: 0 !important; }
      .mobile-overlay { 
        position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); 
        z-index: 99; opacity: 0; visibility: hidden; transition: all 0.3s;
        backdrop-filter: blur(4px);
      }
      .mobile-overlay.active { opacity: 1; visibility: visible; }
    }
    
    /* Print & Export */
    @media print {
      #sidebar, header, .no-print, .mobile-overlay { display: none !important; }
      #mainContent { margin: 0 !important; background: white !important; }
      .glass, .glass-card { 
        box-shadow: none !important; border: 1px solid #ddd !important; 
        border-radius: 0.5rem !important; break-inside: avoid;
      }
      body { background: white !important; }
    }
    
    /* Accessibility */
    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
    }
    :focus-visible {
      outline: 3px solid var(--primary); outline-offset: 2px;
      border-radius: 0.5rem;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 9999px; }
    ::-webkit-scrollbar-thumb { 
      background: linear-gradient(180deg, #94a3b8, #64748b); 
      border-radius: 9999px; border: 2px solid #f1f5f9;
    }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
      background-size: 200% 100%; animation: loading 1.5s infinite;
      border-radius: 0.5rem;
    }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    /* Tooltip */
    .tooltip {
      position: relative; display: inline-block;
    }
    .tooltip .tooltip-text {
      visibility: hidden; width: 200px; background: var(--dark);
      color: #fff; text-align: center; border-radius: 0.75rem;
      padding: 0.75rem 1rem; position: absolute; z-index: 100;
      bottom: 125%; left: 50%; transform: translateX(-50%) translateY(8px);
      opacity: 0; transition: all 0.2s; font-size: 0.85rem;
      box-shadow: var(--shadow-lg); line-height: 1.4;
    }
    .tooltip .tooltip-text::after {
      content: ""; position: absolute; top: 100%; left: 50%;
      margin-left: -5px; border-width: 5px; border-style: solid;
      border-color: var(--dark) transparent transparent transparent;
    }
    .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body class="text-gray-800">

  <!-- ==================== شاشة البداية / التسجيل ==================== -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-blue-50 via-purple-50 to-emerald-50"></div>
    <div class="absolute -top-60 -right-60 w-96 h-96 bg-gradient-to-br from-blue-400/20 to-purple-500/20 rounded-full blur-3xl"></div>
    <div class="absolute -bottom-60 -left-60 w-96 h-96 bg-gradient-to-br from-purple-400/20 to-pink-500/20 rounded-full blur-3xl"></div>
    
    <div class="glass max-w-lg w-full rounded-3xl p-8 relative z-10 shadow-2xl slide-up">
      <div class="text-center mb-8">
        <div class="w-24 h-24 bg-gradient-to-br from-blue-600 via-purple-600 to-emerald-600 rounded-2xl flex items-center justify-center mx-auto shadow-xl transform hover:scale-105 transition duration-300">
          <i class="fas fa-elevator text-white text-4xl"></i>
        </div>
        <h1 class="text-4xl font-black bg-gradient-to-l from-blue-600 via-purple-600 to-emerald-600 bg-clip-text text-transparent mt-5">يمنتكس برو</h1>
        <p class="text-gray-600 mt-3 text-lg">النظام الشامل لإدارة المصاعد والعقارات الذكية</p>
      </div>
      
      <!-- Tabs: تسجيل / دخول -->
      <div class="flex bg-gray-100 rounded-xl p-1 mb-6">
        <button id="tabRegister" class="flex-1 py-2.5 rounded-lg font-semibold transition bg-white shadow text-blue-600">إنشاء حساب جديد</button>
        <button id="tabLogin" class="flex-1 py-2.5 rounded-lg font-semibold transition text-gray-600 hover:text-gray-800">تسجيل الدخول</button>
      </div>
      
      <!-- نموذج التسجيل -->
      <form id="registerForm" class="space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="form-label required">اسم المدير المسؤول</label>
            <input type="text" id="regName" placeholder="الاسم الكامل" class="form-input" required>
          </div>
          <div>
            <label class="form-label required">البريد الإلكتروني</label>
            <input type="email" id="regEmail" placeholder="admin@example.com" class="form-input" required>
          </div>
        </div>
        <div>
          <label class="form-label required">اسم المشروع/العقار</label>
          <input type="text" id="regProject" placeholder="مثال: برج السلام الدولي" class="form-input" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="form-label">رقم الجوال</label>
            <input type="tel" id="regPhone" placeholder="+966 5X XXX XXXX" class="form-input" dir="ltr">
          </div>
          <div>
            <label class="form-label">المدينة</label>
            <select id="regCity" class="form-input">
              <option value="">اختر المدينة</option>
              <option>الرياض</option>
              <option>جدة</option>
              <option>مكة المكرمة</option>
              <option>المدينة المنورة</option>
              <option>الدمام</option>
              <option>أخرى</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="form-label required">كلمة المرور</label>
            <input type="password" id="regPassword" minlength="8" class="form-input" required>
            <p class="form-hint"><i class="fas fa-info-circle"></i> 8 أحرف على الأقل، مع أرقام ورموز</p>
          </div>
          <div>
            <label class="form-label required">تأكيد كلمة المرور</label>
            <input type="password" id="regConfirm" class="form-input" required>
          </div>
        </div>
        <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-xl border border-blue-100">
          <input type="checkbox" id="regTerms" class="mt-1 rounded text-blue-600" required>
          <label for="regTerms" class="text-sm text-gray-700">
            أوافق على <a href="#" class="text-blue-600 hover:underline">شروط الخدمة</a> و
            <a href="#" class="text-blue-600 hover:underline">سياسة الخصوصية</a>، 
            وأقر بأنني المسؤول الوحيد عن إدارة هذا الحساب
          </label>
        </div>
        <button type="submit" id="regBtn" class="w-full bg-gradient-to-l from-blue-600 via-purple-600 to-emerald-600 hover:from-blue-700 hover:via-purple-700 hover:to-emerald-700 text-white font-bold py-4 rounded-xl transition transform hover:scale-[1.02] shadow-xl flex items-center justify-center gap-3">
          <i class="fas fa-user-plus"></i> إنشاء الحساب وبدء الإعداد
        </button>
      </form>
      
      <!-- نموذج الدخول (مخفي افتراضياً) -->
      <form id="loginForm" class="space-y-5 hidden">
        <div>
          <label class="form-label required">البريد الإلكتروني</label>
          <input type="email" id="loginEmail" value="admin@yementex.pro" class="form-input" required>
        </div>
        <div>
          <label class="form-label required">كلمة المرور</label>
          <input type="password" id="loginPassword" value="YemenPro2025!" class="form-input" required>
        </div>
        <div class="flex items-center justify-between text-sm">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="rounded text-blue-600"> تذكرني على هذا الجهاز
          </label>
          <a href="#" class="text-blue-600 hover:underline font-medium">نسيت كلمة المرور؟</a>
        </div>
        <button type="submit" id="loginBtn" class="w-full bg-gradient-to-l from-blue-600 via-purple-600 to-emerald-600 hover:from-blue-700 hover:via-purple-700 hover:to-emerald-700 text-white font-bold py-4 rounded-xl transition transform hover:scale-[1.02] shadow-xl flex items-center justify-center gap-3">
          <i class="fas fa-sign-in-alt"></i> دخول إلى لوحة التحكم
        </button>
        
        <div class="text-center pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-600">
            ليس لديك حساب؟ 
            <button type="button" onclick="switchAuthTab('register')" class="text-blue-600 hover:underline font-semibold">أنشئ حساباً جديداً</button>
          </p>
        </div>
      </form>
      
      <div class="mt-8 pt-6 border-t border-gray-200">
        <p class="text-center text-xs text-gray-500 mb-4">⚡ تجربة سريعة للأغراض التوضيحية:</p>
        <div class="flex flex-wrap justify-center gap-2">
          <button onclick="quickStart('tower')" class="px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-xl text-sm font-medium transition flex items-center gap-2">
            <i class="fas fa-building"></i> أبراج سكنية
          </button>
          <button onclick="quickStart('hotel')" class="px-4 py-2 bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-xl text-sm font-medium transition flex items-center gap-2">
            <i class="fas fa-hotel"></i> فنادق ومنتجعات
          </button>
          <button onclick="quickStart('apartment')" class="px-4 py-2 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 rounded-xl text-sm font-medium transition flex items-center gap-2">
            <i class="fas fa-home"></i> شقق مفروشة
          </button>
          <button onclick="quickStart('hospital')" class="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-xl text-sm font-medium transition flex items-center gap-2">
            <i class="fas fa-hospital"></i> مستشفيات
          </button>
        </div>
      </div>
      
      <p class="text-center text-xs text-gray-400 mt-8">© 2025 يمنتكس برو · نظام إدارة المصاعد المؤسسي · جميع الحقوق محفوظة</p>
    </div>
  </div>

  <!-- ==================== معالج الإعداد الأولي (Onboarding Wizard) ==================== -->
  <div id="onboardingWizard" class="hidden min-h-screen bg-gradient-to-br from-slate-50 to-white flex items-center justify-center p-4">
    <div class="glass max-w-4xl w-full rounded-3xl p-8 shadow-2xl slide-up">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto shadow-lg">
          <i class="fas fa-magic text-white text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mt-4">إعداد نظام يمنتكس برو</h2>
        <p class="text-gray-600">اتبع الخطوات التالية لتخصيص النظام حسب مشروعك</p>
      </div>
      
      <!-- Steps Indicator -->
      <div class="wizard-steps">
        <div class="wizard-step active" data-step="1">
          <div class="wizard-step-number">1</div>
          <div class="wizard-step-label">نوع العقار</div>
        </div>
        <div class="wizard-step" data-step="2">
          <div class="wizard-step-number">2</div>
          <div class="wizard-step-label">تخصيص الوحدات</div>
        </div>
        <div class="wizard-step" data-step="3">
          <div class="wizard-step-number">3</div>
          <div class="wizard-step-label">ربط الأجهزة</div>
        </div>
        <div class="wizard-step" data-step="4">
          <div class="wizard-step-number">4</div>
          <div class="wizard-step-label">اكتمال الإعداد</div>
        </div>
      </div>
      
      <!-- Step 1: Catalog Selection -->
      <div id="wizardStep1" class="wizard-content">
        <h3 class="text-xl font-bold text-gray-800 mb-6">اختر نوع العقار الذي تديره</h3>
        <p class="text-gray-600 mb-6">سيتم تهيئة النظام تلقائياً مع أفضل الممارسات الخاصة بنوع عقارك</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- Tower -->
          <div class="catalog-card" onclick="selectCatalog('tower')">
            <div class="catalog-icon bg-blue-100 text-blue-600">
              <i class="fas fa-building"></i>
            </div>
            <h4 class="font-bold text-lg text-gray-800 mb-2">أبراج سكنية / إدارية</h4>
            <p class="text-sm text-gray-600 mb-4">مثالي للمجمعات السكنية، المكاتب، والمباني متعددة الاستخدامات</p>
            <ul class="text-xs text-gray-500 space-y-1">
              <li><i class="fas fa-check text-green-500 ml-1"></i> إدارة وحدات متعددة (شقق، مكاتب)</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> صلاحيات وصول حسب الطابق/الوحدة</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> تكامل مع أنظمة الأمن والمصاعد</li>
            </ul>
          </div>
          
          <!-- Hotel -->
          <div class="catalog-card" onclick="selectCatalog('hotel')">
            <div class="catalog-icon bg-purple-100 text-purple-600">
              <i class="fas fa-hotel"></i>
            </div>
            <h4 class="font-bold text-lg text-gray-800 mb-2">فنادق ومنتجعات</h4>
            <p class="text-sm text-gray-600 mb-4">مصمم خصيصاً لإدارة الضيوف، الغرف، والخدمات الفندقية</p>
            <ul class="text-xs text-gray-500 space-y-1">
              <li><i class="fas fa-check text-green-500 ml-1"></i> إدارة إقامة الضيوف ومواعيد المغادرة</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> كروت وصول مؤقتة مع صلاحية زمنية</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> تكامل مع أنظمة الحجز (PMS)</li>
            </ul>
          </div>
          
          <!-- Serviced Apartments -->
          <div class="catalog-card" onclick="selectCatalog('apartment')">
            <div class="catalog-icon bg-emerald-100 text-emerald-600">
              <i class="fas fa-home"></i>
            </div>
            <h4 class="font-bold text-lg text-gray-800 mb-2">شقق مفروشة / إقامة قصيرة</h4>
            <p class="text-sm text-gray-600 mb-4">لإدارة الشقق المفروشة، الإيجارات القصيرة، والمجمعات السكنية</p>
            <ul class="text-xs text-gray-500 space-y-1">
              <li><i class="fas fa-check text-green-500 ml-1"></i> دورات إيجار مرنة (يومي، أسبوعي، شهري)</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> إدارة الصيانة والتنظيف التلقائية</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> تقارير إشغال وإيرادات مفصلة</li>
            </ul>
          </div>
          
          <!-- Hospital -->
          <div class="catalog-card" onclick="selectCatalog('hospital')">
            <div class="catalog-icon bg-red-100 text-red-600">
              <i class="fas fa-hospital"></i>
            </div>
            <h4 class="font-bold text-lg text-gray-800 mb-2">مستشفيات ومراكز طبية</h4>
            <p class="text-sm text-gray-600 mb-4">متوافق مع معايير السلامة الطبية وإدارة الوصول الحساسة</p>
            <ul class="text-xs text-gray-500 space-y-1">
              <li><i class="fas fa-check text-green-500 ml-1"></i> مناطق معقمة وصلاحيات طبية متخصصة</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> سجلات تدقيق مفصلة للامتثال</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> بروتوكولات طوارئ طبية مدمجة</li>
            </ul>
          </div>
          
          <!-- Commercial -->
          <div class="catalog-card" onclick="selectCatalog('commercial')">
            <div class="catalog-icon bg-amber-100 text-amber-600">
              <i class="fas fa-store"></i>
            </div>
            <h4 class="font-bold text-lg text-gray-800 mb-2">مجمعات تجارية / مولز</h4>
            <p class="text-sm text-gray-600 mb-4">لإدارة المراكز التجارية، المحلات، والمرافق العامة</p>
            <ul class="text-xs text-gray-500 space-y-1">
              <li><i class="fas fa-check text-green-500 ml-1"></i> إدارة وصول الزوار والموظفين</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> جدولة صيانة المصاعد التجارية</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> تقارير حركة الزوار والتحليلات</li>
            </ul>
          </div>
          
          <!-- Custom -->
          <div class="catalog-card" onclick="selectCatalog('custom')">
            <div class="catalog-icon bg-gray-100 text-gray-600">
              <i class="fas fa-cogs"></i>
            </div>
            <h4 class="font-bold text-lg text-gray-800 mb-2">تخصيص كامل</h4>
            <p class="text-sm text-gray-600 mb-4">ابدأ من الصفر وخصص كل جانب حسب احتياجاتك الفريدة</p>
            <ul class="text-xs text-gray-500 space-y-1">
              <li><i class="fas fa-check text-green-500 ml-1"></i> هيكلة مخصصة للمباني والطوابق</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> قواعد وصول مبرمجة بالكامل</li>
              <li><i class="fas fa-check text-green-500 ml-1"></i> تكامل مع أنظمة خارجية عبر API</li>
            </ul>
          </div>
        </div>
        
        <div class="mt-8 flex justify-end">
          <button onclick="nextWizardStep(2)" id="btnStep1Next" class="px-8 py-3 bg-gradient-to-l from-blue-600 to-purple-600 text-white rounded-xl font-semibold transition hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            التالي <i class="fas fa-arrow-left mr-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 2: Unit Configuration -->
      <div id="wizardStep2" class="wizard-content hidden">
        <h3 class="text-xl font-bold text-gray-800 mb-2">تخصيص أنواع الوحدات</h3>
        <p class="text-gray-600 mb-6">حدد أنواع الوحدات في عقارك وخصائص كل نوع</p>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Available Unit Types -->
          <div class="lg:col-span-2">
            <div class="glass-card p-5 mb-5">
              <h4 class="font-bold text-gray-800 mb-4">أنواع الوحدات المتاحة</h4>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="availableUnitTypes">
                <!-- سيتم تعبئته ديناميكياً حسب catalog -->
              </div>
            </div>
            
            <!-- Selected Unit Types -->
            <div class="glass-card p-5">
              <h4 class="font-bold text-gray-800 mb-4">الوحدات المضافة لمشروعك <span id="selectedCount">(0)</span></h4>
              <div id="selectedUnitTypes" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                <p class="text-sm text-gray-500 text-center py-4">اختر أنواع الوحدات من القائمة أعلاه</p>
              </div>
            </div>
          </div>
          
          <!-- Unit Configuration Form -->
          <div class="glass-card p-5">
            <h4 class="font-bold text-gray-800 mb-4">إعداد نوع الوحدة</h4>
            <div id="unitConfigForm" class="space-y-4">
              <div>
                <label class="form-label">اسم نوع الوحدة</label>
                <input type="text" id="unitTypeName" placeholder="مثال: جناح فاخر، شقة استوديو" class="form-input">
              </div>
              <div>
                <label class="form-label">الرمز التعريفي</label>
                <input type="text" id="unitTypeCode" placeholder="مثال: SUITE-LUX, STD-STUDIO" class="form-input" maxlength="20">
              </div>
              <div>
                <label class="form-label">الطوابق المسموحة</label>
                <div class="flex flex-wrap gap-2 mt-2" id="unitFloorsSelector">
                  <!-- سيتم تعبئته -->
                </div>
              </div>
              <div>
                <label class="form-label">قواعد الوصول الافتراضية</label>
                <div class="space-y-2 mt-2">
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="unitRequireCard" class="rounded text-blue-600" checked>
                    <span>يتطلب كرت وصول للدخول</span>
                  </label>
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="unitAllowGuest" class="rounded text-blue-600">
                    <span>يسمح بوصول الضيوف/الزوار</span>
                  </label>
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="unitTimeRestriction" class="rounded text-blue-600">
                    <span>تقييد زمني للوصول</span>
                  </label>
                </div>
              </div>
              <div id="timeRestrictionFields" class="hidden space-y-3 p-4 bg-gray-50 rounded-xl">
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="form-label text-xs">من</label>
                    <input type="time" class="form-input py-2" value="06:00">
                  </div>
                  <div>
                    <label class="form-label text-xs">إلى</label>
                    <input type="time" class="form-input py-2" value="22:00">
                  </div>
                </div>
                <div>
                  <label class="form-label text-xs">الأيام</label>
                  <div class="flex flex-wrap gap-1">
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" checked class="mr-1"> أحد
                    </label>
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" checked class="mr-1"> اثنين
                    </label>
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" checked class="mr-1"> ثلاثاء
                    </label>
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" checked class="mr-1"> أربعاء
                    </label>
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" checked class="mr-1"> خميس
                    </label>
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" class="mr-1"> جمعة
                    </label>
                    <label class="text-xs bg-white px-2 py-1 rounded border cursor-pointer hover:border-blue-300">
                      <input type="checkbox" class="mr-1"> سبت
                    </label>
                  </div>
                </div>
              </div>
              <button type="button" onclick="addUnitType()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl transition font-medium">
                <i class="fas fa-plus ml-2"></i> إضافة هذا النوع
              </button>
            </div>
          </div>
        </div>
        
        <div class="mt-8 flex justify-between">
          <button onclick="prevWizardStep(1)" class="px-6 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">
            <i class="fas fa-arrow-right ml-2"></i> السابق
          </button>
          <button onclick="nextWizardStep(3)" class="px-8 py-3 bg-gradient-to-l from-blue-600 to-purple-600 text-white rounded-xl font-semibold transition hover:shadow-lg">
            التالي <i class="fas fa-arrow-left mr-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 3: Device Pairing -->
      <div id="wizardStep3" class="wizard-content hidden">
        <h3 class="text-xl font-bold text-gray-800 mb-2">ربط أجهزة المصاعد والتحكم</h3>
        <p class="text-gray-600 mb-6">ابحث عن الأجهزة القريبة وقم بربطها بالنظام</p>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Scanner Panel -->
          <div class="device-scanner">
            <div class="text-center mb-6">
              <div class="w-16 h-16 bg-white/10 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-bluetooth-b text-2xl text-blue-300"></i>
              </div>
              <h4 class="font-bold text-lg">بحث عن أجهزة</h4>
              <p class="text-sm text-gray-300 mt-1">Bluetooth / USB / MQTT</p>
            </div>
            
            <div class="scanner-animation mb-6">
              <div class="scanner-ring"></div>
              <div class="scanner-ring"></div>
              <div class="scanner-ring"></div>
              <button id="scanBtn" onclick="startDeviceScan()" class="relative z-10 w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white shadow-xl hover:scale-105 transition">
                <i class="fas fa-search text-2xl" id="scanIcon"></i>
              </button>
            </div>
            
            <div class="space-y-2 max-h-64 overflow-y-auto pr-2" id="scanResults">
              <p class="text-center text-sm text-gray-400 py-4">اضغط على زر البحث للبدء</p>
            </div>
            
            <div class="mt-6 pt-4 border-t border-white/10">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-300">طريقة الاتصال</span>
                <select id="connectionType" class="bg-white/10 border border-white/20 rounded-lg px-3 py-1.5 text-sm text-white">
                  <option value="bluetooth">Bluetooth 5.0</option>
                  <option value="usb">USB Serial</option>
                  <option value="mqtt">MQTT / WiFi</option>
                  <option value="zigbee">Zigbee 3.0</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Device Configuration -->
          <div class="glass-card p-6">
            <h4 class="font-bold text-gray-800 mb-4">إعداد الجهاز المحدد</h4>
            
            <div id="deviceConfigPanel" class="space-y-4">
              <p class="text-sm text-gray-500 text-center py-8">اختر جهازاً من نتائج البحث لتكوينه</p>
            </div>
            
            <div id="selectedDeviceInfo" class="hidden">
              <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                    <i class="fas fa-microchip text-xl"></i>
                  </div>
                  <div>
                    <p class="font-bold text-gray-800" id="selectedDeviceName">ELV-CTRL-001</p>
                    <p class="text-xs text-gray-600">متحكم مصعد · Bluetooth</p>
                  </div>
                  <span class="badge badge-online mr-auto">جاهز للربط</span>
                </div>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="form-label">اسم المصعد في النظام</label>
                  <input type="text" id="deviceElevatorName" placeholder="مثال: مصعد رئيسي - البرج أ" class="form-input">
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="form-label">المبنى</label>
                    <select id="deviceBuilding" class="form-input">
                      <option>المبنى الرئيسي</option>
                      <option>الملحق الشرقي</option>
                      <option>موقف السيارات</option>
                    </select>
                  </div>
                  <div>
                    <label class="form-label">رقم shaft</label>
                    <input type="text" value="A1" class="form-input">
                  </div>
                </div>
                <div>
                  <label class="form-label">الطوابق المخدمَة</label>
                  <div class="flex flex-wrap gap-2 mt-2" id="deviceFloorsSelector">
                    <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                      <input type="checkbox" checked class="rounded text-blue-600"> أرضي
                    </label>
                    <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                      <input type="checkbox" checked class="rounded text-blue-600"> 1
                    </label>
                    <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                      <input type="checkbox" checked class="rounded text-blue-600"> 2
                    </label>
                    <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                      <input type="checkbox" class="rounded text-blue-600"> 3
                    </label>
                    <button type="button" class="text-blue-600 text-sm hover:underline">+ المزيد</button>
                  </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-green-50 rounded-xl border border-green-100">
                  <input type="checkbox" id="deviceEnableSafety" class="rounded text-green-600" checked>
                  <label for="deviceEnableSafety" class="text-sm text-green-800 font-medium">
                    تفعيل بروتوكولات الأمان المتقدمة
                    <p class="text-xs text-green-700 font-normal mt-0.5">تشمل: كشف الحمل الزائد، الطوارئ التلقائي، سجل التدقيق</p>
                  </label>
                </div>
              </div>
              
              <div class="mt-6 flex gap-3">
                <button onclick="pairDevice()" class="flex-1 bg-gradient-to-l from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-3 rounded-xl font-semibold transition shadow-md">
                  <i class="fas fa-link ml-2"></i> ربط وتفعيل الجهاز
                </button>
                <button onclick="skipDeviceSetup()" class="px-6 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">
                  تخطي الآن
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mt-8 flex justify-between">
          <button onclick="prevWizardStep(2)" class="px-6 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">
            <i class="fas fa-arrow-right ml-2"></i> السابق
          </button>
          <button onclick="completeOnboarding()" class="px-8 py-3 bg-gradient-to-l from-green-600 to-emerald-600 text-white rounded-xl font-semibold transition hover:shadow-lg">
            <i class="fas fa-check ml-2"></i> اكتمال الإعداد والبدء
          </button>
        </div>
      </div>
      
      <!-- Step 4: Completion -->
      <div id="wizardStep4" class="wizard-content hidden text-center">
        <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-float">
          <i class="fas fa-check text-4xl text-white"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-3">تم إعداد نظامك بنجاح! 🎉</h3>
        <p class="text-gray-600 mb-8 max-w-md mx-auto">
          تم تهيئة يمنتكس برو خصيصاً لـ <span id="completionProjectName" class="font-bold text-blue-600">مشروعك</span> 
          مع <span id="completionUnitCount" class="font-bold">0</span> نوع وحدة و
          <span id="completionDeviceCount" class="font-bold">0</span> جهاز متصل
        </p>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 max-w-2xl mx-auto">
          <div class="glass-card p-5">
            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-3 text-blue-600">
              <i class="fas fa-tachometer-alt text-xl"></i>
            </div>
            <p class="font-bold text-gray-800">لوحة التحكم</p>
            <p class="text-sm text-gray-600 mt-1">مراقبة فورية لحالة جميع المصاعد</p>
          </div>
          <div class="glass-card p-5">
            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mx-auto mb-3 text-purple-600">
              <i class="fas fa-id-card text-xl"></i>
            </div>
            <p class="font-bold text-gray-800">إدارة الكروت</p>
            <p class="text-sm text-gray-600 mt-1">إصدار وتتبع بطاقات الوصول</p>
          </div>
          <div class="glass-card p-5">
            <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center mx-auto mb-3 text-emerald-600">
              <i class="fas fa-chart-line text-xl"></i>
            </div>
            <p class="font-bold text-gray-800">التقارير</p>
            <p class="text-sm text-gray-600 mt-1">تحليلات مفصلة لأداء النظام</p>
          </div>
        </div>
        
        <button onclick="enterMainApp()" class="px-10 py-4 bg-gradient-to-l from-blue-600 via-purple-600 to-emerald-600 hover:from-blue-700 hover:via-purple-700 hover:to-emerald-700 text-white rounded-2xl font-bold text-lg transition transform hover:scale-[1.03] shadow-2xl flex items-center justify-center gap-3 mx-auto">
          <i class="fas fa-rocket"></i> الانتقال إلى لوحة التحكم
        </button>
        
        <p class="text-sm text-gray-500 mt-6">
          يمكنك تعديل أي إعداد لاحقاً من قسم <span class="font-medium text-blue-600">الإعدادات</span>
        </p>
      </div>
    </div>
  </div>

  <!-- ==================== التطبيق الرئيسي ==================== -->
  <div id="mainApp" class="hidden flex h-screen overflow-hidden">
    
    <!-- Sidebar Pro -->
    <nav id="sidebar" class="glass-dark text-white h-full transition-all duration-300 overflow-y-auto flex flex-col z-50" style="width: 17rem;">
      <div class="p-5 flex items-center justify-between border-b border-white/10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-emerald-500 rounded-xl flex items-center justify-center shadow-lg flex-shrink-0">
            <i class="fas fa-elevator text-white"></i>
          </div>
          <span class="font-black text-xl sidebar-text">يمنتكس برو</span>
        </div>
        <button id="collapseSidebar" class="text-gray-300 hover:text-white p-1.5 rounded-lg transition hidden lg:block">
          <i class="fas fa-chevron-right text-lg"></i>
        </button>
      </div>
      
      <!-- Project Info -->
      <div class="mx-4 mt-4 p-4 bg-white/10 rounded-xl tenant-info">
        <div class="flex items-center gap-2 text-sm">
          <i class="fas fa-building text-blue-300"></i>
          <span class="sidebar-text font-bold" id="projectName">برج السلام الدولي</span>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-300 mt-2">
          <i class="fas fa-tag"></i>
          <span class="sidebar-text" id="projectType">أبراج سكنية</span>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-300 mt-1">
          <i class="fas fa-calendar-check"></i>
          <span class="sidebar-text">اشتراك مؤسسي · <span class="text-green-300 font-medium">غير محدود</span></span>
        </div>
      </div>
      
      <!-- Navigation -->
      <ul class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
        <li><div onclick="navigate('dashboard')" class="sidebar-item active" id="navDashboard">
          <i class="fas fa-tachometer-alt w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">لوحة التحكم</span>
        </div></li>
        <li><div onclick="navigate('elevators')" class="sidebar-item" id="navElevators">
          <i class="fas fa-elevator w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">المصاعد</span>
          <span class="badge sidebar-badge sidebar-text" id="elevatorCount">0</span>
        </div></li>
        <li><div onclick="navigate('cards')" class="sidebar-item" id="navCards">
          <i class="fas fa-id-card w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">بطاقات الوصول</span>
          <span class="badge sidebar-badge sidebar-text" id="cardCount">0</span>
        </div></li>
        <li><div onclick="navigate('property')" class="sidebar-item" id="navProperty">
          <i class="fas fa-sitemap w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">هيكل العقار</span>
        </div></li>
        <li><div onclick="navigate('units')" class="sidebar-item" id="navUnits">
          <i class="fas fa-door-open w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">الوحدات والسكان</span>
        </div></li>
        <li><div onclick="navigate('maintenance')" class="sidebar-item" id="navMaintenance">
          <i class="fas fa-tools w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">الصيانة</span>
        </div></li>
        <li><div onclick="navigate('alerts')" class="sidebar-item" id="navAlerts">
          <i class="fas fa-bell w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">التنبيهات</span>
          <span class="badge badge-new sidebar-badge sidebar-text" id="alertCount">3</span>
        </div></li>
        <li><div onclick="navigate('reports')" class="sidebar-item" id="navReports">
          <i class="fas fa-chart-pie w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">التقارير</span>
        </div></li>
        <li><div onclick="navigate('team')" class="sidebar-item" id="navTeam">
          <i class="fas fa-users-gear w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">الفريق والصلاحيات</span>
        </div></li>
        <li><div onclick="navigate('devices')" class="sidebar-item" id="navDevices">
          <i class="fas fa-microchip w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">الأجهزة والاتصال</span>
        </div></li>
        <li><div onclick="navigate('settings')" class="sidebar-item" id="navSettings">
          <i class="fas fa-cog w-6 text-center sidebar-icon"></i>
          <span class="sidebar-text">الإعدادات</span>
        </div></li>
      </ul>
      
      <!-- User Profile -->
      <div class="p-4 border-t border-white/10 mt-auto">
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0">
              <i class="fas fa-user text-white"></i>
            </div>
            <span class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 border-2 border-gray-900 rounded-full animate-pulse"></span>
          </div>
          <div class="flex-1 min-w-0 sidebar-text">
            <p class="text-sm font-bold truncate" id="userName">أحمد محمد</p>
            <p class="text-xs text-gray-400 truncate">مدير النظام · صلاحيات كاملة</p>
          </div>
          <button onclick="logout()" class="text-gray-400 hover:text-red-400 p-2 transition" title="تسجيل الخروج">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="flex-1 overflow-y-auto bg-slate-50 transition-all duration-300">
      
      <!-- Header -->
      <header class="glass border-b border-gray-200 sticky top-0 z-10 px-6 py-4 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <button id="mobileMenuBtn" class="lg:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-xl">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <div>
            <h1 id="pageTitle" class="text-2xl font-black text-gray-800">لوحة التحكم</h1>
            <p id="pageSubtitle" class="text-sm text-gray-500">نظرة شاملة على نظام إدارة المصاعد</p>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <!-- Quick Search -->
          <div class="relative hidden md:block">
            <input type="text" id="globalSearch" placeholder="ابحث عن مصعد، كرت، وحدة..." class="pl-10 pr-4 py-2.5 w-64 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition text-sm">
            <i class="fas fa-search absolute right-3.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>
          
          <!-- Notifications -->
          <button class="p-2.5 text-gray-600 hover:bg-gray-100 rounded-xl relative transition" onclick="navigate('alerts')">
            <i class="fas fa-bell text-xl"></i>
            <span class="absolute top-1.5 right-1.5 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
          </button>
          
          <!-- Quick Actions Dropdown -->
          <div class="relative">
            <button id="quickActionsBtn" class="p-2.5 text-gray-600 hover:bg-gray-100 rounded-xl transition">
              <i class="fas fa-plus text-xl"></i>
            </button>
            <div id="quickActionsMenu" class="hidden absolute left-0 mt-2 w-56 glass rounded-xl shadow-xl py-2 z-50">
              <button onclick="openModal('cardModal')" class="w-full text-right px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3">
                <i class="fas fa-id-card text-blue-600"></i> إصدار كرت جديد
              </button>
              <button onclick="openModal('elevatorModal')" class="w-full text-right px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3">
                <i class="fas fa-elevator text-purple-600"></i> إضافة مصعد
              </button>
              <button onclick="openModal('maintenanceModal')" class="w-full text-right px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3">
                <i class="fas fa-tools text-orange-600"></i> جدولة صيانة
              </button>
              <button onclick="generateQuickReport()" class="w-full text-right px-4 py-2.5 hover:bg-gray-50 flex items-center gap-3">
                <i class="fas fa-file-export text-emerald-600"></i> تقرير سريع
              </button>
            </div>
          </div>
          
          <!-- Emergency Button -->
          <button onclick="triggerEmergency()" class="bg-gradient-to-l from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 transition shadow-lg hover:shadow-xl">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="hidden sm:inline font-semibold">طوارئ</span>
          </button>
        </div>
      </header>

      <!-- ========== Dashboard Screen ========== -->
      <div id="dashboardScreen" class="p-6 space-y-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5" id="dashboardStats"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Live Elevator Status -->
          <div class="lg:col-span-2 glass-card p-6">
            <div class="flex items-center justify-between mb-5">
              <h3 class="font-black text-gray-800 flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                حالة المصاعد (مباشر)
              </h3>
              <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full font-medium">
                <i class="fas fa-sync-alt animate-spin ml-1"></i> تحديث: <span id="lastUpdate">الآن</span>
              </span>
            </div>
            <div id="elevatorStatusList" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
          </div>
          
          <!-- Side Panel -->
          <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="glass-card p-6">
              <h3 class="font-black text-gray-800 mb-4">إجراءات سريعة</h3>
              <div class="grid grid-cols-2 gap-3">
                <button onclick="openModal('cardModal')" class="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-4 rounded-xl text-center transition transform hover:scale-[1.02] shadow-md">
                  <i class="fas fa-plus-circle text-xl mb-2"></i>
                  <span class="block text-xs font-bold">إصدار كرت</span>
                </button>
                <button onclick="openModal('elevatorModal')" class="bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-4 rounded-xl text-center transition transform hover:scale-[1.02] shadow-md">
                  <i class="fas fa-elevator text-xl mb-2"></i>
                  <span class="block text-xs font-bold">إضافة مصعد</span>
                </button>
                <button onclick="openModal('maintenanceModal')" class="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-4 rounded-xl text-center transition transform hover:scale-[1.02] shadow-md">
                  <i class="fas fa-tools text-xl mb-2"></i>
                  <span class="block text-xs font-bold">صيانة عاجلة</span>
                </button>
                <button onclick="generateQuickReport()" class="bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white p-4 rounded-xl text-center transition transform hover:scale-[1.02] shadow-md">
                  <i class="fas fa-file-export text-xl mb-2"></i>
                  <span class="block text-xs font-bold">تقرير فوري</span>
                </button>
              </div>
            </div>
            
            <!-- Recent Activities -->
            <div class="glass-card p-6">
              <h3 class="font-black text-gray-800 mb-4 flex items-center justify-between">
                <span>آخر النشاطات</span>
                <button class="text-xs text-blue-600 hover:underline font-medium">عرض السجل الكامل</button>
              </h3>
              <div id="recentActivities" class="space-y-3 max-h-64 overflow-y-auto pr-1"></div>
            </div>
            
            <!-- System Health -->
            <div class="glass-card p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100">
              <h3 class="font-black text-gray-800 mb-4">صحة النظام</h3>
              <div class="space-y-3">
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-600">جاهزية المصاعد</span>
                    <span class="font-bold text-green-600">98.7%</span>
                  </div>
                  <div class="progress"><div class="progress-fill green" style="width: 98.7%"></div></div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-600">استجابة الأجهزة</span>
                    <span class="font-bold text-blue-600">142ms</span>
                  </div>
                  <div class="progress"><div class="progress-fill blue" style="width: 94%"></div></div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-600">سعة التخزين</span>
                    <span class="font-bold text-purple-600">67%</span>
                  </div>
                  <div class="progress"><div class="progress-fill purple" style="width: 67%"></div></div>
                </div>
              </div>
              <button class="w-full mt-4 bg-white hover:bg-gray-50 text-gray-700 py-2 rounded-xl text-sm font-medium transition border border-gray-200">
                عرض تقرير الصحة الكامل
              </button>
            </div>
          </div>
        </div>
        
        <!-- Analytics Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4">استخدام المصاعد (آخر 24 ساعة)</h3>
            <canvas id="usageChart" height="220"></canvas>
          </div>
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4">توزيع حالات الكروت</h3>
            <canvas id="cardsChart" height="220"></canvas>
          </div>
        </div>
      </div>

      <!-- ========== Elevators Screen ========== -->
      <div id="elevatorsScreen" class="p-6 hidden space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <h2 class="text-2xl font-black text-gray-800">إدارة المصاعد والأجهزة</h2>
          <div class="flex gap-3">
            <button onclick="openModal('elevatorModal')" class="bg-gradient-to-l from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-md font-semibold">
              <i class="fas fa-plus"></i> إضافة مصعد جديد
            </button>
            <button onclick="openModal('pairDeviceModal')" class="bg-white border-2 border-gray-300 hover:border-blue-400 text-gray-700 hover:text-blue-600 px-5 py-2.5 rounded-xl flex items-center gap-2 transition font-semibold">
              <i class="fas fa-bluetooth"></i> ربط جهاز
            </button>
          </div>
        </div>
        
        <!-- Filters & Stats -->
        <div class="glass-card p-5">
          <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
            <div class="flex flex-wrap gap-3">
              <select id="elevatorFilter" class="form-input w-auto py-2 px-4" onchange="filterElevators()">
                <option value="all">كل المصاعد</option>
                <option value="online">نشط</option>
                <option value="maintenance">صيانة</option>
                <option value="offline">متوقف</option>
                <option value="emergency">طوارئ</option>
              </select>
              <select id="buildingFilter" class="form-input w-auto py-2 px-4" onchange="filterElevators()">
                <option value="all">كل المباني</option>
                <option value="برج السلام">برج السلام</option>
                <option value="المبنى الإداري">المبنى الإداري</option>
                <option value="مجمع عدن">مجمع عدن</option>
              </select>
              <select id="manufacturerFilter" class="form-input w-auto py-2 px-4" onchange="filterElevators()">
                <option value="all">كل المصانع</option>
                <option value="Otis">Otis</option>
                <option value="Schindler">Schindler</option>
                <option value="Kone">Kone</option>
                <option value="Mitsubishi">Mitsubishi</option>
              </select>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-600 font-medium">
              <i class="fas fa-sync-alt animate-spin text-blue-500"></i>
              <span>تحديث فوري كل 10 ثوانٍ</span>
            </div>
          </div>
          
          <!-- Stats Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="elevatorStatsCards"></div>
        </div>
        
        <!-- Elevators Grid -->
        <div id="elevatorsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-5"></div>
      </div>

      <!-- ========== Cards Screen ========== -->
      <div id="cardsScreen" class="p-6 hidden space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <h2 class="text-2xl font-black text-gray-800">إدارة بطاقات الوصول</h2>
          <button onclick="openModal('cardModal')" class="bg-gradient-to-l from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-md font-semibold">
            <i class="fas fa-plus"></i> إصدار كرت جديد
          </button>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="cardStatsCards"></div>
        
        <!-- Filters -->
        <div class="glass-card p-5">
          <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
              <label class="form-label text-xs font-semibold">بحث متقدم</label>
              <input type="text" id="cardSearch" placeholder="اسم، رقم كرت، غرفة، هاتف..." class="form-input py-2.5" oninput="filterCards()">
            </div>
            <div>
              <label class="form-label text-xs font-semibold">الحالة</label>
              <select id="cardFilter" class="form-input w-auto py-2.5 px-4" onchange="filterCards()">
                <option value="all">كل الحالات</option>
                <option value="active">نشط</option>
                <option value="expired">منتهي</option>
                <option value="blocked">محظور</option>
                <option value="suspended">معلق</option>
                <option value="lost">مفقود</option>
              </select>
            </div>
            <div>
              <label class="form-label text-xs font-semibold">نوع المستخدم</label>
              <select id="cardTypeFilter" class="form-input w-auto py-2.5 px-4" onchange="filterCards()">
                <option value="all">الكل</option>
                <option value="نزيل">نزيل</option>
                <option value="مستأجر">مستأجر</option>
                <option value="موظف">موظف</option>
                <option value="مقاول">مقاول</option>
                <option value="زائر">زائر</option>
              </select>
            </div>
            <div class="flex items-end gap-2">
              <button onclick="exportCards('excel')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 transition font-medium">
                <i class="fas fa-file-excel"></i> Excel
              </button>
              <button onclick="exportCards('pdf')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 transition font-medium">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
            </div>
          </div>
        </div>
        
        <!-- Cards Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>الكرت</th>
                  <th>المالك</th>
                  <th>النوع/الوحدة</th>
                  <th>الصلاحيات</th>
                  <th>الرصيد/الصلاحية</th>
                  <th>الحالة</th>
                  <th>آخر استخدام</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="cardsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========== Property Structure Screen ========== -->
      <div id="propertyScreen" class="p-6 hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-black text-gray-800">هيكل العقار: <span id="propertyTitle">برج السلام الدولي</span></h2>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 transition font-semibold">
            <i class="fas fa-plus"></i> إضافة مبنى
          </button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Buildings -->
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4 flex items-center justify-between">
              <span>المباني</span>
              <span class="text-xs bg-blue-100 text-blue-700 px-2.5 py-1 rounded-full font-bold">3 مباني</span>
            </h3>
            <div class="space-y-3">
              <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100 cursor-pointer hover:shadow-md transition" onclick="selectBuilding('برج السلام')">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                      <i class="fas fa-building"></i>
                    </div>
                    <div>
                      <p class="font-bold">برج السلام</p>
                      <p class="text-xs text-gray-500">12 طابق · 48 وحدة</p>
                    </div>
                  </div>
                  <i class="fas fa-chevron-left text-gray-400"></i>
                </div>
              </div>
              <div class="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer hover:shadow-md transition" onclick="selectBuilding('المبنى الإداري')">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600">
                      <i class="fas fa-building"></i>
                    </div>
                    <div>
                      <p class="font-bold">المبنى الإداري</p>
                      <p class="text-xs text-gray-500">5 طوابق · 20 مكتب</p>
                    </div>
                  </div>
                  <i class="fas fa-chevron-left text-gray-400"></i>
                </div>
              </div>
              <div class="p-4 bg-white rounded-xl border border-gray-100 cursor-pointer hover:shadow-md transition" onclick="selectBuilding('مجمع عدن')">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600">
                      <i class="fas fa-building"></i>
                    </div>
                    <div>
                      <p class="font-bold">مجمع عدن</p>
                      <p class="text-xs text-gray-500">8 طوابق · 32 شقة</p>
                    </div>
                  </div>
                  <i class="fas fa-chevron-left text-gray-400"></i>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Floors -->
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4">طوابق <span id="selectedBuilding">برج السلام</span></h3>
            <div class="space-y-2 max-h-80 overflow-y-auto pr-2" id="floorsList">
              <!-- Dynamic -->
            </div>
          </div>
          
          <!-- Units -->
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4">الوحدات - طابق <span id="selectedFloor">أرضي</span></h3>
            <div class="grid grid-cols-2 gap-3" id="unitsGrid">
              <!-- Dynamic -->
            </div>
          </div>
        </div>
      </div>

      <!-- ========== Units & Residents Screen ========== -->
      <div id="unitsScreen" class="p-6 hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-black text-gray-800">إدارة الوحدات والسكان</h2>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl flex items-center gap-2 transition font-semibold">
            <i class="fas fa-user-plus"></i> إضافة مقيم جديد
          </button>
        </div>
        
        <!-- Unit Types Overview -->
        <div class="glass-card p-6">
          <h3 class="font-black text-gray-800 mb-4">أنواع الوحدات في مشروعك</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="unitTypesOverview">
            <!-- Dynamic based on catalog -->
          </div>
        </div>
        
        <!-- Units Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="p-5 border-b border-gray-200 flex flex-wrap items-center justify-between gap-4">
            <h3 class="font-black text-gray-800">قائمة الوحدات</h3>
            <div class="flex gap-2">
              <input type="text" placeholder="بحث برقم الوحدة أو اسم المقيم..." class="form-input w-64 py-2 px-4 text-sm">
              <select class="form-input w-auto py-2 px-4 text-sm">
                <option>كل الأنواع</option>
                <option>شقة</option>
                <option>جناح</option>
                <option>غرفة</option>
              </select>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>الوحدة</th>
                  <th>النوع</th>
                  <th>المبنى/الطابق</th>
                  <th>الحالة</th>
                  <th>المقيم الرئيسي</th>
                  <th>تاريخ الإشغال</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><span class="font-bold text-blue-600">A-109</span></td>
                  <td><span class="badge badge-online">جناح فاخر</span></td>
                  <td>برج السلام · طابق 10</td>
                  <td><span class="badge badge-online">مشغول</span></td>
                  <td>أحمد محمد</td>
                  <td>15 فبراير 2025</td>
                  <td>
                    <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                    <button class="text-green-600 hover:text-green-800 p-1.5"><i class="fas fa-id-card"></i></button>
                    <button class="text-gray-400 hover:text-gray-600 p-1.5"><i class="fas fa-ellipsis-v"></i></button>
                  </td>
                </tr>
                <tr>
                  <td><span class="font-bold text-purple-600">B-205</span></td>
                  <td><span class="badge badge-maintenance">شقة عائلية</span></td>
                  <td>مجمع عدن · طابق 2</td>
                  <td><span class="badge badge-warning">صيانة</span></td>
                  <td>-</td>
                  <td>-</td>
                  <td>
                    <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                    <button class="text-green-600 hover:text-green-800 p-1.5"><i class="fas fa-id-card"></i></button>
                    <button class="text-gray-400 hover:text-gray-600 p-1.5"><i class="fas fa-ellipsis-v"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========== Maintenance Screen ========== -->
      <div id="maintenanceScreen" class="p-6 hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-black text-gray-800">جدولة ومتابعة الصيانة</h2>
          <button onclick="openModal('maintenanceModal')" class="bg-gradient-to-l from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-md font-semibold">
            <i class="fas fa-plus"></i> جدولة صيانة جديدة
          </button>
        </div>
        
        <!-- Maintenance Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-blue-600" id="pendingMaintenance">2</p>
            <p class="text-sm text-gray-600 font-medium">صيانة مجدولة</p>
          </div>
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-green-600" id="completedMaintenance">15</p>
            <p class="text-sm text-gray-600 font-medium">مكتملة هذا الشهر</p>
          </div>
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-yellow-600" id="overdueMaintenance">1</p>
            <p class="text-sm text-gray-600 font-medium">متأخرة</p>
          </div>
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-purple-600">98.5%</p>
            <p class="text-sm text-gray-600 font-medium">معدل الجاهزية</p>
          </div>
        </div>
        
        <!-- Maintenance Tasks Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>المهمة</th>
                  <th>المصعد</th>
                  <th>نوع الصيانة</th>
                  <th>تاريخ الجدولة</th>
                  <th>الفني المسؤول</th>
                  <th>الحالة</th>
                  <th>التقدم</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="maintenanceTableBody">
                <tr>
                  <td>فحص المحرك الرئيسي</td>
                  <td>مصعد رئيسي A1</td>
                  <td><span class="badge badge-maintenance">دورية</span></td>
                  <td>25 فبراير 2025</td>
                  <td>خالد أحمد</td>
                  <td><span class="badge badge-online">مجدول</span></td>
                  <td><div class="progress"><div class="progress-fill blue" style="width: 0%"></div></div></td>
                  <td>
                    <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                    <button class="text-green-600 hover:text-green-800 p-1.5"><i class="fas fa-check"></i></button>
                  </td>
                </tr>
                <tr>
                  <td>استبدال كابلات الأمان</td>
                  <td>مصعد خدمي B2</td>
                  <td><span class="badge badge-warning">طارئة</span></td>
                  <td>20 فبراير 2025</td>
                  <td>محمد سالم</td>
                  <td><span class="badge badge-maintenance">قيد التنفيذ</span></td>
                  <td><div class="progress"><div class="progress-fill yellow" style="width: 75%"></div></div></td>
                  <td>
                    <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                    <button class="text-green-600 hover:text-green-800 p-1.5"><i class="fas fa-check"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========== Alerts Screen ========== -->
      <div id="alertsScreen" class="p-6 hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-black text-gray-800">مركز التنبيهات والإنذارات</h2>
          <div class="flex gap-2">
            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition">تحديد الكل كمقروء</button>
            <button class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl text-sm font-medium transition">مسح التنبيهات</button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Alerts List -->
          <div class="lg:col-span-2 space-y-4">
            <!-- Critical Alert -->
            <div class="glass-card rounded-2xl p-5 border-r-4 border-red-500">
              <div class="flex items-start justify-between">
                <div class="flex items-start gap-4">
                  <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center text-red-600 flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                  </div>
                  <div>
                    <h4 class="font-black text-gray-800">ارتفاع حرارة محرك المصعد A1</h4>
                    <p class="text-sm text-gray-600 mt-1">تم رصد درجة حرارة 87°C في محرك المصعد الرئيسي - يتجاوز الحد الآمن (85°C)</p>
                    <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                      <span><i class="fas fa-clock ml-1"></i> منذ 12 دقيقة</span>
                      <span><i class="fas fa-map-marker-alt ml-1"></i> برج السلام - الدور 7</span>
                      <span class="badge badge-emergency">عالي الخطورة</span>
                    </div>
                  </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times"></i></button>
              </div>
              <div class="mt-4 flex gap-3">
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition">إرسال فريق صيانة</button>
                <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">عرض التفاصيل</button>
              </div>
            </div>
            
            <!-- Warning Alert -->
            <div class="glass-card rounded-2xl p-5 border-r-4 border-yellow-500">
              <div class="flex items-start justify-between">
                <div class="flex items-start gap-4">
                  <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center text-yellow-600 flex-shrink-0">
                    <i class="fas fa-tools text-xl"></i>
                  </div>
                  <div>
                    <h4 class="font-black text-gray-800">موعد صيانة دوري لمصعد B2</h4>
                    <p class="text-sm text-gray-600 mt-1">موعد الصيانة الدورية لمصعد الخدمات يقترب خلال 3 أيام</p>
                    <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                      <span><i class="fas fa-clock ml-1"></i> منذ ساعة</span>
                      <span><i class="fas fa-calendar ml-1"></i> 28 فبراير 2025</span>
                      <span class="badge badge-maintenance">متوسط</span>
                    </div>
                  </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times"></i></button>
              </div>
              <div class="mt-4 flex gap-3">
                <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">جدولة الآن</button>
                <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">تأجيل</button>
              </div>
            </div>
            
            <!-- Info Alert -->
            <div class="glass-card rounded-2xl p-5 border-r-4 border-blue-500">
              <div class="flex items-start justify-between">
                <div class="flex items-start gap-4">
                  <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 flex-shrink-0">
                    <i class="fas fa-id-card text-xl"></i>
                  </div>
                  <div>
                    <h4 class="font-black text-gray-800">انتهاء صلاحية 3 كروت</h4>
                    <p class="text-sm text-gray-600 mt-1">كرت غرفة 301، شقة 205، وموظف أحمد سينتهي خلال 48 ساعة</p>
                    <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                      <span><i class="fas fa-clock ml-1"></i> منذ 3 ساعات</span>
                      <span><i class="fas fa-users ml-1"></i> 3 مستخدمين متأثرين</span>
                      <span class="badge badge-online">معلومات</span>
                    </div>
                  </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times"></i></button>
              </div>
              <div class="mt-4 flex gap-3">
                <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition">تمديد الصلاحية</button>
                <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">عرض الكروت</button>
              </div>
            </div>
          </div>
          
          <!-- Alert Settings -->
          <div class="glass-card rounded-2xl p-6">
            <h3 class="font-black text-gray-800 mb-4">إعدادات التنبيهات</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <div>
                  <p class="font-semibold text-sm">تنبيهات الأعطال الحرجة</p>
                  <p class="text-xs text-gray-500">إشعار فوري عند حدوث عطل خطير</p>
                </div>
                <label class="toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <div>
                  <p class="font-semibold text-sm">تذكير الصيانة الدورية</p>
                  <p class="text-xs text-gray-500">قبل 7 أيام من موعد الصيانة</p>
                </div>
                <label class="toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <div>
                  <p class="font-semibold text-sm">انتهاء صلاحية الكروت</p>
                  <p class="text-xs text-gray-500">قبل 48 ساعة من الانتهاء</p>
                </div>
                <label class="toggle">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="pt-4 border-t border-gray-200">
                <p class="text-sm font-semibold mb-3">قنوات الإشعار</p>
                <div class="space-y-2">
                  <label class="flex items-center gap-2 text-sm cursor-pointer">
                    <input type="checkbox" checked class="rounded text-blue-600"> إشعارات داخل التطبيق
                  </label>
                  <label class="flex items-center gap-2 text-sm cursor-pointer">
                    <input type="checkbox" checked class="rounded text-blue-600"> بريد إلكتروني
                  </label>
                  <label class="flex items-center gap-2 text-sm cursor-pointer">
                    <input type="checkbox" class="rounded text-blue-600"> رسائل SMS (لحالات الطوارئ فقط)
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== Reports Screen ========== -->
      <div id="reportsScreen" class="p-6 hidden space-y-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <h2 class="text-2xl font-black text-gray-800">التقارير والتحليلات</h2>
          <div class="flex gap-2">
            <select id="reportPeriod" class="form-input w-auto py-2.5 px-4">
              <option value="today">اليوم</option>
              <option value="week" selected>آخر 7 أيام</option>
              <option value="month">آخر 30 يوم</option>
              <option value="custom">فترة مخصصة</option>
            </select>
            <button onclick="generateReport('full')" class="bg-gradient-to-l from-blue-600 to-purple-600 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-md font-semibold">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
          </div>
        </div>
        
        <!-- Report Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="glass-card rounded-xl p-5">
            <p class="text-sm text-gray-600 font-medium">إجمالي الرحلات</p>
            <p class="text-2xl font-black text-gray-800 mt-1">1,247</p>
            <p class="text-xs text-green-600 font-semibold mt-1"><i class="fas fa-arrow-up ml-1"></i> +12% عن الأسبوع الماضي</p>
          </div>
          <div class="glass-card rounded-xl p-5">
            <p class="text-sm text-gray-600 font-medium">متوسط وقت الانتظار</p>
            <p class="text-2xl font-black text-gray-800 mt-1">18.3 ثانية</p>
            <p class="text-xs text-green-600 font-semibold mt-1"><i class="fas fa-arrow-down ml-1"></i> -2.1s تحسن</p>
          </div>
          <div class="glass-card rounded-xl p-5">
            <p class="text-sm text-gray-600 font-medium">معدل استخدام المصاعد</p>
            <p class="text-2xl font-black text-gray-800 mt-1">76.4%</p>
            <div class="progress mt-2"><div class="progress-fill blue" style="width: 76.4%"></div></div>
          </div>
          <div class="glass-card rounded-xl p-5">
            <p class="text-sm text-gray-600 font-medium">رضا المستخدمين</p>
            <p class="text-2xl font-black text-gray-800 mt-1">4.7/5</p>
            <div class="flex text-yellow-400 text-sm mt-1">
              <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i>
            </div>
          </div>
        </div>
        
        <!-- Advanced Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4">رحلات المصاعد حسب الطابق</h3>
            <canvas id="floorUsageChart" height="250"></canvas>
          </div>
          <div class="glass-card p-6">
            <h3 class="font-black text-gray-800 mb-4">أوقات الذروة (ساعة بساعة)</h3>
            <canvas id="peakHoursChart" height="250"></canvas>
          </div>
        </div>
        
        <!-- Trips Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="p-5 border-b border-gray-200 flex items-center justify-between">
            <h3 class="font-black text-gray-800">تفاصيل الرحلات (آخر 50 رحلة)</h3>
            <button class="text-sm text-blue-600 hover:underline font-medium">عرض الكل</button>
          </div>
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>الوقت</th>
                  <th>المصعد</th>
                  <th>من</th>
                  <th>إلى</th>
                  <th>المستخدم</th>
                  <th>طريقة الوصول</th>
                  <th>المدة</th>
                </tr>
              </thead>
              <tbody id="tripsTableBody">
                <!-- Dynamic -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========== Team & Permissions Screen ========== -->
      <div id="teamScreen" class="p-6 hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-black text-gray-800">إدارة الفريق والصلاحيات</h2>
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-md font-semibold">
            <i class="fas fa-user-plus"></i> إضافة عضو جديد
          </button>
        </div>
        
        <!-- Team Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-blue-600">1</p>
            <p class="text-sm text-gray-600 font-medium">مدير النظام</p>
          </div>
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-purple-600">3</p>
            <p class="text-sm text-gray-600 font-medium">فنيين صيانة</p>
          </div>
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-green-600">5</p>
            <p class="text-sm text-gray-600 font-medium">موظفي استقبال</p>
          </div>
          <div class="glass-card rounded-xl p-5 text-center">
            <p class="text-3xl font-black text-amber-600">12</p>
            <p class="text-sm text-gray-600 font-medium">مستخدمين محدودي الصلاحية</p>
          </div>
        </div>
        
        <!-- Team Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <table class="data-table">
            <thead>
              <tr>
                <th>العضو</th>
                <th>الدور</th>
                <th>البريد/الهاتف</th>
                <th>آخر دخول</th>
                <th>الحالة</th>
                <th>الصلاحيات</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">أ</div>
                    <div>
                      <p class="font-bold">أحمد محمد</p>
                      <p class="text-xs text-gray-500">مدير النظام</p>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-online">مدير كامل</span></td>
                <td>ahmed@yementex.pro<br><span class="text-xs text-gray-400">+966 5X XXX XXXX</span></td>
                <td>منذ 5 دقائق</td>
                <td><span class="badge badge-online">نشط</span></td>
                <td><span class="text-xs text-gray-600">صلاحيات كاملة</span></td>
                <td>
                  <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                  <button class="text-gray-400 hover:text-gray-600 p-1.5"><i class="fas fa-ellipsis-v"></i></button>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold">خ</div>
                    <div>
                      <p class="font-bold">خالد عبدالله</p>
                      <p class="text-xs text-gray-500">فني صيانة أول</p>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-maintenance">فني</span></td>
                <td>khaled@yementex.pro<br><span class="text-xs text-gray-400">+966 5Y YYY YYYY</span></td>
                <td>منذ ساعة</td>
                <td><span class="badge badge-online">نشط</span></td>
                <td><span class="text-xs text-gray-600">صيانة، قراءة فقط</span></td>
                <td>
                  <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-edit"></i></button>
                  <button class="text-gray-400 hover:text-gray-600 p-1.5"><i class="fas fa-ellipsis-v"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ========== Devices Screen ========== -->
      <div id="devicesScreen" class="p-6 hidden space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-black text-gray-800">إدارة الأجهزة والاتصال</h2>
          <button onclick="openModal('pairDeviceModal')" class="bg-gradient-to-l from-blue-600 to-purple-600 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-md font-semibold">
            <i class="fas fa-plus"></i> ربط جهاز جديد
          </button>
        </div>
        
        <!-- Connection Status -->
        <div class="glass-card p-6">
          <h3 class="font-black text-gray-800 mb-4">حالة الاتصال بالأجهزة</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center text-green-600">
                  <i class="fas fa-wifi text-lg"></i>
                </div>
                <div>
                  <p class="font-bold text-gray-800">MQTT Broker</p>
                  <p class="text-xs text-green-700">متصل · 23ms</p>
                </div>
              </div>
            </div>
            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                  <i class="fas fa-bluetooth-b text-lg"></i>
                </div>
                <div>
                  <p class="font-bold text-gray-800">Bluetooth Gateway</p>
                  <p class="text-xs text-blue-700">متصل · 45ms</p>
                </div>
              </div>
            </div>
            <div class="p-4 bg-amber-50 rounded-xl border border-amber-100">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600">
                  <i class="fas fa-database text-lg"></i>
                </div>
                <div>
                  <p class="font-bold text-gray-800">قاعدة البيانات المحلية</p>
                  <p class="text-xs text-amber-700">مزامنة · 120ms</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Connected Devices Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>الجهاز</th>
                  <th>النوع</th>
                  <th>طريقة الاتصال</th>
                  <th>المصعد المرتبط</th>
                  <th>آخر اتصال</th>
                  <th>الحالة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                        <i class="fas fa-microchip"></i>
                      </div>
                      <div>
                        <p class="font-bold">ELV-CTRL-A1</p>
                        <p class="text-xs text-gray-500">SN: OTIS-78945</p>
                      </div>
                    </div>
                  </td>
                  <td>متحكم مصعد</td>
                  <td><span class="badge badge-online">MQTT</span></td>
                  <td>مصعد رئيسي A1</td>
                  <td>منذ 8 ثوانٍ</td>
                  <td><span class="badge badge-online">متصل</span></td>
                  <td>
                    <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-cog"></i></button>
                    <button class="text-green-600 hover:text-green-800 p-1.5"><i class="fas fa-sync"></i></button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center text-purple-600">
                        <i class="fas fa-id-card"></i>
                      </div>
                      <div>
                        <p class="font-bold">CARD-READER-B2</p>
                        <p class="text-xs text-gray-500">SN: HID-45612</p>
                      </div>
                    </div>
                  </td>
                  <td>قارئ كروت</td>
                  <td><span class="badge badge-maintenance">USB</span></td>
                  <td>مصعد خدمي B2</td>
                  <td>منذ 2 دقيقة</td>
                  <td><span class="badge badge-maintenance">صيانة</span></td>
                  <td>
                    <button class="text-blue-600 hover:text-blue-800 p-1.5"><i class="fas fa-cog"></i></button>
                    <button class="text-green-600 hover:text-green-800 p-1.5"><i class="fas fa-sync"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ========== Settings Screen ========== -->
      <div id="settingsScreen" class="p-6 hidden space-y-6">
        <h2 class="text-2xl font-black text-gray-800">إعدادات النظام</h2>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Property Settings -->
          <div class="lg:col-span-2 space-y-6">
            <div class="glass-card rounded-2xl p-6">
              <h3 class="font-black text-gray-800 mb-5 pb-3 border-b border-gray-200">معلومات العقار</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                  <label class="form-label required">اسم المنشأة</label>
                  <input type="text" value="برج السلام الدولي" class="form-input">
                </div>
                <div>
                  <label class="form-label required">نوع المنشأة</label>
                  <select class="form-input">
                    <option>أبراج سكنية</option>
                    <option>فندق</option>
                    <option>شقق مفروشة</option>
                    <option>مجمع تجاري</option>
                    <option>مستشفى</option>
                    <option>مبنى إداري</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">العنوان الكامل</label>
                  <input type="text" value="طريق الملك فهد، حي العليا، الرياض" class="form-input">
                </div>
                <div>
                  <label class="form-label">رقم الترخيص البلدي</label>
                  <input type="text" value="BLD-2023-45678" class="form-input">
                </div>
                <div class="md:col-span-2">
                  <label class="form-label">أرقام الطوارئ</label>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="tel" placeholder="الدفاع المدني" value="998" class="form-input">
                    <input type="tel" placeholder="الصيانة العاجلة" value="+966 11 XXX XXXX" class="form-input">
                    <input type="tel" placeholder="الأمن" value="999" class="form-input">
                  </div>
                </div>
              </div>
              <div class="mt-6 flex justify-end">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition font-semibold">حفظ التغييرات</button>
              </div>
            </div>
            
            <!-- System Settings -->
            <div class="glass-card rounded-2xl p-6">
              <h3 class="font-black text-gray-800 mb-5 pb-3 border-b border-gray-200">إعدادات النظام المتقدمة</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                  <div>
                    <p class="font-semibold">تحديث البيانات الفوري (WebSocket)</p>
                    <p class="text-sm text-gray-600">مزامنة لحظية مع أجهزة المصاعد عبر MQTT</p>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                  <div>
                    <p class="font-semibold">النسخ الاحتياطي التلقائي</p>
                    <p class="text-sm text-gray-600">نسخ احتياطي مشفر للسحابة يومياً الساعة 2:00 صباحاً</p>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                  <div>
                    <p class="font-semibold">وضع الصيانة الشامل</p>
                    <p class="text-sm text-gray-600">إيقاف جميع المصاعد تلقائياً للصيانة المجدولة</p>
                  </div>
                  <button class="px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-lg text-sm font-medium transition">تفعيل الآن</button>
                </div>
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                  <div>
                    <p class="font-semibold">التدقيق الأمني المتقدم</p>
                    <p class="text-sm text-gray-600">تسجيل جميع عمليات الوصول والتغييرات الحساسة</p>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sidebar Settings -->
          <div class="space-y-6">
            <div class="glass-card rounded-2xl p-6">
              <h3 class="font-black text-gray-800 mb-4">النسخ الاحتياطي والاستعادة</h3>
              <p class="text-sm text-gray-600 mb-4">آخر نسخة: اليوم 02:00 ص · 24.5 ميجا · مشفر</p>
              <button class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl transition font-medium mb-3">إنشاء نسخة احتياطية الآن</button>
              <button class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 py-3 rounded-xl transition font-medium">استعادة نسخة سابقة</button>
            </div>
            
            <div class="glass-card rounded-2xl p-6">
              <h3 class="font-black text-gray-800 mb-4">سجل التدقيق الأمني</h3>
              <p class="text-sm text-gray-600 mb-4">تتبع جميع التغييرات والعمليات الحساسة في النظام</p>
              <button class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl transition font-medium">عرض السجل الكامل</button>
            </div>
            
            <div class="glass-card rounded-2xl p-6 bg-gradient-to-br from-red-50 to-pink-50 border border-red-100">
              <h3 class="font-black text-red-800 mb-3">منطقة الخطر</h3>
              <p class="text-sm text-red-700 mb-4">إجراءات لا يمكن التراجع عنها - تتطلب تأكيداً إضافياً</p>
              <button class="w-full bg-red-100 hover:bg-red-200 text-red-700 py-3 rounded-xl transition font-medium text-sm">حذف جميع البيانات التجريبية</button>
            </div>
          </div>
        </div>
      </div>

    </main>
    
    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay"></div>
  </div>

  <!-- ==================== Modals ==================== -->
  
  <!-- Modal: Add/Edit Elevator -->
  <div id="elevatorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-black text-gray-800">إضافة مصعد جديد</h3>
        <button onclick="closeModal('elevatorModal')" class="text-gray-400 hover:text-gray-600 p-2">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="modal-body space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="form-label required">اسم المصعد في النظام</label>
            <input type="text" placeholder="مثال: مصعد رئيسي A1" class="form-input">
          </div>
          <div>
            <label class="form-label required">الرقم التسلسلي (Serial)</label>
            <input type="text" placeholder="ELV-2025-XXXX" class="form-input">
          </div>
          <div>
            <label class="form-label">الشركة المصنعة</label>
            <select class="form-input">
              <option>Otis</option>
              <option>Schindler</option>
              <option>Kone</option>
              <option>Mitsubishi</option>
              <option>ThyssenKrupp</option>
              <option>أخرى</option>
            </select>
          </div>
          <div>
            <label class="form-label">المبنى</label>
            <select class="form-input">
              <option>برج السلام</option>
              <option>المبنى الإداري</option>
              <option>مجمع عدن</option>
            </select>
          </div>
          <div>
            <label class="form-label">السعة القصوى (كجم)</label>
            <input type="number" value="1000" class="form-input">
          </div>
          <div>
            <label class="form-label">السرعة القصوى (م/ث)</label>
            <input type="number" step="0.1" value="1.5" class="form-input">
          </div>
          <div class="md:col-span-2">
            <label class="form-label">الطوابق المخدمَة</label>
            <div class="flex flex-wrap gap-2 mt-2">
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                <input type="checkbox" checked class="rounded text-blue-600"> أرضي
              </label>
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                <input type="checkbox" checked class="rounded text-blue-600"> 1
              </label>
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                <input type="checkbox" checked class="rounded text-blue-600"> 2
              </label>
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                <input type="checkbox" class="rounded text-blue-600"> 3
              </label>
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
                <input type="checkbox" class="rounded text-blue-600"> 4
              </label>
              <button class="text-blue-600 text-sm font-medium hover:underline">+ إضافة المزيد</button>
            </div>
          </div>
        </div>
        
        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
          <h4 class="font-semibold text-blue-800 mb-2"><i class="fas fa-shield-alt ml-1"></i> ميزات الأمان المضمنة</h4>
          <ul class="text-sm text-blue-700 space-y-1.5">
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> نظام طوارئ تلقائي عند انقطاع الكهرباء</li>
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> كشف الحمل الزائد وإيقاف التشغيل الآمن</li>
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> اتصال مباشر مع غرفة المراقبة والدفاع المدني</li>
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> سجل تدقيق كامل لجميع عمليات الوصول</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('elevatorModal')" class="px-5 py-2.5 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">إلغاء</button>
        <button onclick="saveElevator()" class="px-5 py-2.5 bg-gradient-to-l from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition shadow-md font-semibold">حفظ المصعد</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Issue New Card -->
  <div id="cardModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-black text-gray-800">إصدار كرت وصول جديد</h3>
        <button onclick="closeModal('cardModal')" class="text-gray-400 hover:text-gray-600 p-2">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="modal-body space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="form-label required">اسم حامل الكرت</label>
            <input type="text" placeholder="الاسم الكامل" class="form-input">
          </div>
          <div>
            <label class="form-label required">نوع المستخدم</label>
            <select class="form-input" id="cardHolderType" onchange="updateCardPermissions()">
              <option value="نزيل">نزيل فندق</option>
              <option value="مستأجر">مستأجر شقة</option>
              <option value="موظف">موظف/عامل</option>
              <option value="مقاول">مقاول/زائر</option>
              <option value="طبيب">طبيب/طاقم طبي</option>
            </select>
          </div>
          <div>
            <label class="form-label">الوحدة/الغرفة</label>
            <input type="text" placeholder="مثال: جناح 109، شقة B-205" class="form-input">
          </div>
          <div>
            <label class="form-label">رقم الهوية/الجوال للتحقق</label>
            <input type="text" placeholder="لأغراض الأمان" class="form-input">
          </div>
        </div>
        
        <!-- Access Permissions -->
        <div>
          <label class="form-label required">صلاحيات الوصول</label>
          <div class="p-4 bg-gray-50 rounded-xl space-y-4">
            <div>
              <p class="text-sm font-semibold mb-2">المباني المسموحة</p>
              <div class="flex flex-wrap gap-2">
                <label class="flex items-center gap-1.5 text-sm bg-white px-3 py-1.5 rounded-lg border cursor-pointer hover:border-blue-300">
                  <input type="checkbox" checked class="rounded text-blue-600"> برج السلام
                </label>
                <label class="flex items-center gap-1.5 text-sm bg-white px-3 py-1.5 rounded-lg border cursor-pointer hover:border-blue-300">
                  <input type="checkbox" class="rounded text-blue-600"> المبنى الإداري
                </label>
              </div>
            </div>
            <div>
              <p class="text-sm font-semibold mb-2">الطوابق المسموحة</p>
              <div class="flex flex-wrap gap-2" id="cardFloorsContainer">
                <!-- Dynamic based on unit type -->
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="form-label text-xs font-semibold">تاريخ البدء</label>
                <input type="date" class="form-input py-2.5" value="2025-02-23">
              </div>
              <div>
                <label class="form-label text-xs font-semibold">تاريخ الانتهاء</label>
                <input type="date" class="form-input py-2.5" value="2025-12-31">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Wallet & Payment Options -->
        <div class="p-4 bg-green-50 rounded-xl border border-green-100">
          <h4 class="font-semibold text-green-800 mb-3"><i class="fas fa-coins ml-1"></i> خيارات الدفع والشحن (اختياري)</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="form-label text-xs">رصيد ابتدائي (ريال)</label>
              <input type="number" value="0" class="form-input py-2.5">
            </div>
            <div>
              <label class="form-label text-xs">شحن تلقائي عند</label>
              <select class="form-input py-2.5">
                <option>غير مفعل</option>
                <option>عند 10 ريال</option>
                <option>عند 20 ريال</option>
                <option>عند 50 ريال</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('cardModal')" class="px-5 py-2.5 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">إلغاء</button>
        <button onclick="issueCard()" class="px-5 py-2.5 bg-gradient-to-l from-green-600 to-emerald-600 text-white rounded-xl hover:from-green-700 hover:to-emerald-700 transition shadow-md font-semibold">
          <i class="fas fa-print ml-2"></i> طباعة وتفعيل الكرت
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Schedule Maintenance -->
  <div id="maintenanceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-black text-gray-800">جدولة مهمة صيانة جديدة</h3>
        <button onclick="closeModal('maintenanceModal')" class="text-gray-400 hover:text-gray-600 p-2">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="modal-body space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="form-label required">المصعد</label>
            <select class="form-input">
              <option>مصعد رئيسي A1 - برج السلام</option>
              <option>مصعد خدمي B2 - المبنى الإداري</option>
              <option>مصعد شمالي C3 - مجمع عدن</option>
            </select>
          </div>
          <div>
            <label class="form-label required">نوع الصيانة</label>
            <select class="form-input">
              <option>صيانة دورية وقائية</option>
              <option>فحص أمان طارئ</option>
              <option>استبدال قطع غيار</option>
              <option>ترقية برمجية/ Firmware</option>
              <option>فحص بعد عطل</option>
            </select>
          </div>
          <div>
            <label class="form-label required">تاريخ ووقت التنفيذ</label>
            <input type="datetime-local" class="form-input py-2.5">
          </div>
          <div>
            <label class="form-label">الفني/الفريق المسؤول</label>
            <select class="form-input">
              <option>خالد أحمد - فني أول</option>
              <option>محمد سالم - فني معتمد</option>
              <option>فريق الصيانة الخارجي</option>
            </select>
          </div>
        </div>
        
        <div>
          <label class="form-label">وصف المهمة والملاحظات الفنية</label>
          <textarea class="form-input min-h-[100px]" placeholder="اكتب تفاصيل المهمة، القطع المطلوبة، التعليمات الخاصة، إجراءات السلامة..."></textarea>
        </div>
        
        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-100">
          <h4 class="font-semibold text-yellow-800 mb-2"><i class="fas fa-exclamation-triangle ml-1"></i> تنبيهات السلامة التلقائية</h4>
          <ul class="text-sm text-yellow-700 space-y-1.5">
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> سيتم إيقاف المصعد تلقائياً قبل 15 دقيقة من موعد الصيانة</li>
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> سيتم إشعار المستخدمين المتأثرين عبر التطبيق والرسائل القصيرة</li>
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> يجب تأكيد إتمام المهمة خلال 24 ساعة من الجدولة</li>
            <li><i class="fas fa-check-circle text-green-500 ml-1"></i> سيتم تحديث سجل التدقيق تلقائياً عند البدء والانتهاء</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('maintenanceModal')" class="px-5 py-2.5 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">إلغاء</button>
        <button onclick="scheduleMaintenance()" class="px-5 py-2.5 bg-gradient-to-l from-orange-500 to-red-500 text-white rounded-xl hover:from-orange-600 hover:to-red-600 transition shadow-md font-semibold">تأكيد الجدولة</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Pair Device -->
  <div id="pairDeviceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="text-xl font-black text-gray-800">ربط جهاز جديد</h3>
        <button onclick="closeModal('pairDeviceModal')" class="text-gray-400 hover:text-gray-600 p-2">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="device-scanner mb-6">
          <div class="text-center mb-4">
            <h4 class="font-bold">بحث عن أجهزة قريبة</h4>
            <p class="text-sm text-gray-300">Bluetooth / USB / MQTT</p>
          </div>
          <div class="scanner-animation mb-4">
            <div class="scanner-ring"></div>
            <div class="scanner-ring"></div>
            <button onclick="startDeviceScan()" class="relative z-10 w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg">
              <i class="fas fa-search text-xl" id="pairScanIcon"></i>
            </button>
          </div>
          <div class="space-y-2 max-h-48 overflow-y-auto pr-2" id="pairScanResults">
            <p class="text-center text-sm text-gray-400 py-3">اضغط على زر البحث للبدء</p>
          </div>
        </div>
        
        <div id="pairConfigPanel" class="hidden space-y-4">
          <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                <i class="fas fa-microchip"></i>
              </div>
              <div>
                <p class="font-bold text-gray-800" id="pairDeviceName">ELV-CTRL-NEW</p>
                <p class="text-xs text-gray-600">متحكم مصعد · Bluetooth 5.0</p>
              </div>
              <span class="badge badge-online mr-auto">جاهز</span>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="form-label">اسم المصعد في النظام</label>
              <input type="text" class="form-input" placeholder="مثال: مصعد جديد X1">
            </div>
            <div>
              <label class="form-label">المبنى</label>
              <select class="form-input">
                <option>برج السلام</option>
                <option>المبنى الإداري</option>
                <option>مجمع عدن</option>
              </select>
            </div>
          </div>
          
          <div>
            <label class="form-label">الطوابق المخدمَة</label>
            <div class="flex flex-wrap gap-2 mt-2">
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer">
                <input type="checkbox" checked class="rounded text-blue-600"> أرضي
              </label>
              <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer">
                <input type="checkbox" checked class="rounded text-blue-600"> 1
              </label>
              <button class="text-blue-600 text-sm hover:underline">+ المزيد</button>
            </div>
          </div>
          
          <div class="flex items-center gap-3 p-3 bg-green-50 rounded-xl border border-green-100">
            <input type="checkbox" id="pairEnableSafety" class="rounded text-green-600" checked>
            <label for="pairEnableSafety" class="text-sm text-green-800 font-medium">
              تفعيل بروتوكولات الأمان المتقدمة
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeModal('pairDeviceModal')" class="px-5 py-2.5 border border-gray-300 rounded-xl hover:bg-gray-50 transition font-medium">إلغاء</button>
        <button onclick="confirmPairDevice()" class="px-5 py-2.5 bg-gradient-to-l from-blue-600 to-purple-600 text-white rounded-xl hover:from-blue-700 hover:to-purple-700 transition shadow-md font-semibold">
          <i class="fas fa-link ml-2"></i> ربط وتفعيل
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== Notification System ==================== -->
  <div id="notificationContainer"></div>

  <!-- ==================== JavaScript Logic ==================== -->
  <script>
    // =====================================================
    // 1. AppState - البيانات المركزية (محاكاة قاعدة بيانات)
    // =====================================================
    const AppState = {
      // Session & Auth
      session: {
        userId: 'usr_admin_001',
        userName: 'أحمد محمد',
        userEmail: 'admin@yementex.pro',
        project: {
          id: 'proj_001',
          name: 'برج السلام الدولي',
          type: 'tower', // tower, hotel, apartment, hospital, commercial, custom
          catalog: {
            selected: 'tower',
            unitTypes: [
              { id: 'apt', name: 'شقة عائلية', code: 'FAM-APT', floors: [1,2,3,4,5,6,7,8,9,10,11,12], requireCard: true, allowGuest: false },
              { id: 'suite', name: 'جناح فاخر', code: 'LUX-SUITE', floors: [10,11,12], requireCard: true, allowGuest: true, timeRestriction: { start: '00:00', end: '23:59', days: ['sun','mon','tue','wed','thu','fri','sat'] } },
              { id: 'office', name: 'مكتب إداري', code: 'ADMIN-OFF', floors: [1,2,3,4,5], requireCard: true, allowGuest: true, timeRestriction: { start: '07:00', end: '18:00', days: ['sun','mon','tue','wed','thu'] } }
            ]
          },
          buildings: [
            { id: 'b1', name: 'برج السلام', floors: 12, units: 48 },
            { id: 'b2', name: 'المبنى الإداري', floors: 5, units: 20 },
            { id: 'b3', name: 'مجمع عدن', floors: 8, units: 32 }
          ]
        },
        onboardingComplete: false,
        createdAt: new Date().toISOString()
      },
      
      // Elevators (45+ fields per best practices)
      elevators: [
        {
          id: 'e1', tenantId: 'proj_001', serialNumber: 'OTIS-2023-A1-78945',
          manufacturer: 'Otis', model: 'Gen2® Comfort', installationDate: '2023-06-15',
          warrantyExpiry: '2028-06-15',
          building: 'برج السلام', shaft: 'A1', location: { floor: 0, doorSide: 'center' },
          specs: { capacity: 1000, speed: 1.6, floorsServed: [0,1,2,3,4,5,6,7,8,9,10,11], doorType: 'center', driveType: 'MRL', powerSupply: '380V-3Phase', emergencyFeatures: ['battery', 'phone', 'alarm', 'fireMode'] },
          telemetry: { status: 'online', currentFloor: 7, targetFloor: 10, direction: 'up', doorState: 'closed', loadPercent: 45, motorTemp: 62.3, vibrationLevel: 1.2, lastPing: new Date().toISOString(), signalStrength: -45, firmwareVersion: 'v3.2.1' },
          maintenance: { lastService: '2025-01-15', nextService: '2025-04-15', serviceIntervalDays: 90, totalTrips: 15847, totalDistance: 42.3, components: { cables: { installed: '2023-06-15', expectedLife: 15 }, doors: { cycles: 89450, lastLubrication: '2025-01-15' }, controller: { firmware: 'v3.2.1', lastUpdate: '2024-11-20' } } },
          accessRules: { requireCard: true, allowGuest: false, restrictedFloors: [10,11], timeBasedRules: [] },
          meta: { createdAt: '2023-06-01T10:00:00Z', updatedAt: new Date().toISOString(), createdBy: 'usr_admin_001', tags: ['main', 'guest-access'] }
        },
        {
          id: 'e2', tenantId: 'proj_001', serialNumber: 'SCH-2022-B2-45612',
          manufacturer: 'Schindler', model: '5500', installationDate: '2022-11-20',
          building: 'المبنى الإداري', shaft: 'B2', location: { floor: 0 },
          specs: { capacity: 1350, speed: 2.0, floorsServed: [0,1,2,3,4], doorType: 'side', driveType: 'traction', powerSupply: '380V-3Phase', emergencyFeatures: ['battery', 'alarm'] },
          telemetry: { status: 'maintenance', currentFloor: 2, direction: 'idle', doorState: 'open', loadPercent: 0, motorTemp: 45.1, vibrationLevel: 0.8, lastPing: new Date(Date.now()-900000).toISOString(), signalStrength: -62, firmwareVersion: 'v2.8.4', maintenanceProgress: 75 },
          maintenance: { lastService: '2025-02-20', nextService: '2025-02-23', serviceIntervalDays: 90, totalTrips: 28934, totalDistance: 89.7 },
          accessRules: { requireCard: true, allowGuest: false, restrictedFloors: [] },
          meta: { createdAt: '2022-11-01T09:00:00Z', updatedAt: new Date().toISOString(), tags: ['service', 'staff-only'] }
        },
        {
          id: 'e3', tenantId: 'proj_001', serialNumber: 'KONE-2024-C3-99123',
          manufacturer: 'Kone', model: 'MonoSpace® 500', installationDate: '2024-03-10',
          building: 'مجمع عدن', shaft: 'C3', location: { floor: 0 },
          specs: { capacity: 800, speed: 1.0, floorsServed: [0,1,2,3,4,5,6,7], doorType: 'center', driveType: 'MRL', powerSupply: '220V-1Phase', emergencyFeatures: ['battery', 'phone'] },
          telemetry: { status: 'online', currentFloor: 3, targetFloor: 5, direction: 'up', doorState: 'closed', loadPercent: 60, motorTemp: 58.7, vibrationLevel: 1.5, lastPing: new Date().toISOString(), signalStrength: -38, firmwareVersion: 'v4.1.0' },
          maintenance: { lastService: '2025-02-01', nextService: '2025-05-01', serviceIntervalDays: 90, totalTrips: 3421, totalDistance: 12.8 },
          accessRules: { requireCard: true, allowGuest: true, restrictedFloors: [6,7] },
          meta: { createdAt: '2024-03-01T08:00:00Z', updatedAt: new Date().toISOString(), tags: ['residential', 'eco-mode'] }
        }
      ],
      
      // Access Cards
      cards: [
        { id: 'c1', tenantId: 'proj_001', cardNumber: '****1234', uid: 'A1B2C3D4',
          holder: { type: 'نزيل', userId: 'usr_101', name: 'أحمد محمد', phone: '+966501234567', idDocument: '1023456789' },
          permissions: { buildings: ['برج السلام'], floors: [10,11,12], elevators: ['e1'], timeWindows: [{ days: ['sun','mon','tue','wed','thu','fri','sat'], start: '00:00', end: '23:59' }], validFrom: '2025-02-15', validUntil: '2025-02-28' },
          wallet: { balance: 0, currency: 'SAR' },
          status: 'active', security: { lastUsedAt: new Date(Date.now()-600000).toISOString(), lastUsedElevator: 'e1', failedAttempts: 0 },
          audit: { issuedBy: 'usr_admin_001', issuedAt: '2025-02-15T10:30:00Z' }
        },
        { id: 'c2', tenantId: 'proj_001', cardNumber: '****5678', uid: 'E5F6G7H8',
          holder: { type: 'مستأجر', name: 'فاطمة علي', phone: '+966509876543' },
          permissions: { buildings: ['مجمع عدن'], floors: [3], elevators: ['e3'], timeWindows: [{ days: ['sun','mon','tue','wed','thu','fri','sat'], start: '06:00', end: '22:00' }], validFrom: '2024-06-01', validUntil: '2025-01-14' },
          status: 'expired', security: { lastUsedAt: new Date(Date.now()-432000000).toISOString(), failedAttempts: 0 },
          audit: { issuedBy: 'usr_admin_001', issuedAt: '2024-06-01T09:00:00Z' }
        },
        { id: 'c3', tenantId: 'proj_001', cardNumber: '****9012', uid: 'I9J0K1L2',
          holder: { type: 'موظف', name: 'محمد حسن', phone: '+966505551234', idDocument: '1098765432' },
          permissions: { buildings: ['برج السلام','المبنى الإداري'], floors: [0,1,2,3,4,5,6,7,8,9,10], elevators: ['e1','e2'], timeWindows: [{ days: ['sun','mon','tue','wed','thu'], start: '07:00', end: '19:00' }], validFrom: '2024-01-01', validUntil: '2025-12-31' },
          status: 'active', security: { lastUsedAt: new Date().toISOString(), failedAttempts: 0 },
          audit: { issuedBy: 'usr_admin_001', issuedAt: '2024-01-01T08:00:00Z' }
        }
      ],
      
      // Audit Logs
      auditLogs: [
        { id: 'log1', actor: { userId: 'usr_101', role: 'نزيل', ipAddress: '192.168.1.45' }, action: 'card_used', resource: { type: 'elevator', id: 'e1' }, details: { fromFloor: 10, toFloor: 12, result: 'granted' }, outcome: 'success', timestamp: new Date(Date.now()-600000).toISOString() },
        { id: 'log2', actor: { userId: 'usr_admin_001', role: 'admin', ipAddress: '192.168.1.10' }, action: 'card_issued', resource: { type: 'card', id: 'c1' }, details: { holder: 'أحمد محمد', floors: [10,11,12] }, outcome: 'success', timestamp: new Date(Date.now()-86400000).toISOString() }
      ],
      
      // Recent Activities
      recentActivities: [
        { user: 'أحمد محمد', action: 'استخدم مصعد A1 للوصول إلى طابق 12', time: 'منذ 10 د', icon: 'arrow-up', bg: 'blue', elevator: 'e1' },
        { user: 'فاطمة علي', action: 'محاولة استخدام كرت منتهي الصلاحية', time: 'منذ 25 د', icon: 'exclamation-circle', bg: 'yellow', denied: true },
        { user: 'النظام', action: 'تنبيه: صيانة دورية لمصعد B2 خلال 3 أيام', time: 'منذ ساعة', icon: 'tools', bg: 'orange' },
        { user: 'محمد حسن', action: 'شحن كرت الموظف بمبلغ 100 ريال', time: 'منذ ساعتين', icon: 'credit-card', bg: 'green' }
      ],
      
      // Devices
      devices: [
        { id: 'dev1', name: 'ELV-CTRL-A1', type: 'elevator_controller', connection: 'mqtt', elevatorId: 'e1', lastPing: new Date().toISOString(), status: 'online' },
        { id: 'dev2', name: 'CARD-READER-B2', type: 'card_reader', connection: 'usb', elevatorId: 'e2', lastPing: new Date(Date.now()-120000).toISOString(), status: 'maintenance' }
      ]
    };

    // =====================================================
    // 2. Utility Functions
    // =====================================================
    function $(id) { return document.getElementById(id); }
    function $$(selector) { return document.querySelectorAll(selector); }
    
    function formatNumber(num) {
      return new Intl.NumberFormat('ar-SA').format(num);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return new Intl.DateTimeFormat('ar-SA', { year: 'numeric', month: 'short', day: 'numeric' }).format(date);
    }
    
    function getTimeAgo(dateStr) {
      if (!dateStr) return 'غير معروف';
      const now = new Date();
      const date = new Date(dateStr);
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return 'الآن';
      if (diff < 3600) return `منذ ${Math.floor(diff/60)} دقيقة`;
      if (diff < 86400) return `منذ ${Math.floor(diff/3600)} ساعة`;
      return formatDate(dateStr);
    }
    
    function generateId(prefix = 'id') {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    // =====================================================
    // 3. Auth & Onboarding Functions
    // =====================================================
    function switchAuthTab(tab) {
      if (tab === 'register') {
        $('registerForm').classList.remove('hidden');
        $('loginForm').classList.add('hidden');
        $('tabRegister').classList.add('bg-white', 'shadow', 'text-blue-600');
        $('tabRegister').classList.remove('text-gray-600');
        $('tabLogin').classList.remove('bg-white', 'shadow', 'text-blue-600');
        $('tabLogin').classList.add('text-gray-600');
      } else {
        $('registerForm').classList.add('hidden');
        $('loginForm').classList.remove('hidden');
        $('tabLogin').classList.add('bg-white', 'shadow', 'text-blue-600');
        $('tabLogin').classList.remove('text-gray-600');
        $('tabRegister').classList.remove('bg-white', 'shadow', 'text-blue-600');
        $('tabRegister').classList.add('text-gray-600');
      }
    }
    
    // Initialize tabs
    $('tabRegister')?.addEventListener('click', () => switchAuthTab('register'));
    $('tabLogin')?.addEventListener('click', () => switchAuthTab('login'));
    
    // Register Form
    $('registerForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const btn = $('regBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></span> جاري الإنشاء...';
      btn.disabled = true;
      
      setTimeout(() => {
        // Save to AppState
        AppState.session.userName = $('regName').value;
        AppState.session.userEmail = $('regEmail').value;
        AppState.session.project.name = $('regProject').value;
        AppState.session.onboardingComplete = false;
        
        // Show onboarding wizard
        $('authScreen').classList.add('hidden');
        $('onboardingWizard').classList.remove('hidden');
        $('projectName').textContent = AppState.session.project.name;
        
        showNotification('تم إنشاء حسابك بنجاح! 🎉 نبدأ الآن في إعداد نظامك', 'success');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 1500);
    });
    
    // Login Form
    $('loginForm')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const btn = $('loginBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></span> جاري الدخول...';
      btn.disabled = true;
      
      setTimeout(() => {
        // Check if onboarding is complete
        if (AppState.session.onboardingComplete) {
          $('authScreen').classList.add('hidden');
          $('mainApp').classList.remove('hidden');
          refreshAll();
          showNotification('مرحباً بعودتك في يمنتكس برو', 'success');
        } else {
          $('authScreen').classList.add('hidden');
          $('onboardingWizard').classList.remove('hidden');
          showNotification('نبدأ بإعداد نظامك لأول مرة', 'info');
        }
        btn.innerHTML = originalText;
        btn.disabled = false;
      }, 1200);
    });
    
    // Quick Start for Demo
    function quickStart(catalogType) {
      AppState.session.project.type = catalogType;
      AppState.session.catalog.selected = catalogType;
      AppState.session.onboardingComplete = true;
      
      // Pre-fill catalog-specific unit types
      const catalogUnits = {
        tower: [{ id: 'apt', name: 'شقة عائلية', code: 'FAM-APT' }, { id: 'office', name: 'مكتب', code: 'ADMIN-OFF' }],
        hotel: [{ id: 'room', name: 'غرفة فندقية', code: 'STD-ROOM' }, { id: 'suite', name: 'جناح', code: 'LUX-SUITE' }],
        apartment: [{ id: 'studio', name: 'استوديو', code: 'STD-STUDIO' }, { id: 'apt', name: 'شقة', code: 'FAM-APT' }],
        hospital: [{ id: 'room', name: 'غرفة مرضى', code: 'PAT-ROOM' }, { id: 'lab', name: 'مختبر', code: 'MED-LAB' }]
      };
      AppState.session.catalog.unitTypes = catalogUnits[catalogType] || catalogUnits.tower;
      
      $('authScreen').classList.add('hidden');
      $('mainApp').classList.remove('hidden');
      $('projectType').textContent = {tower:'أبراج سكنية', hotel:'فنادق', apartment:'شقق مفروشة', hospital:'مستشفيات'}[catalogType] || 'مخصص';
      
      refreshAll();
      showNotification('تم تحميل إعدادات ' + {tower:'الأبراج', hotel:'الفنادق', apartment:'الشقق', hospital:'المستشفيات'}[catalogType] + ' الجاهزة', 'success');
    }
    
    // =====================================================
    // 4. Onboarding Wizard Functions
    // =====================================================
    let currentWizardStep = 1;
    
    function selectCatalog(catalog) {
      // Visual selection
      $$('.catalog-card').forEach(card => card.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      
      // Enable next button
      $('btnStep1Next').disabled = false;
      
      // Store selection
      AppState.session.catalog.selected = catalog;
      
      // Pre-load unit types for step 2
      loadUnitTypesForCatalog(catalog);
    }
    
    function loadUnitTypesForCatalog(catalog) {
      const catalogData = {
        tower: {
          available: [
            { id: 'apt', name: 'شقة عائلية', icon: 'fa-home' },
            { id: 'office', name: 'مكتب إداري', icon: 'fa-building' },
            { id: 'suite', name: 'جناح فاخر', icon: 'fa-crown' },
            { id: 'studio', name: 'استوديو', icon: 'fa-door-open' }
          ],
          defaults: ['apt', 'office']
        },
        hotel: {
          available: [
            { id: 'room', name: 'غرفة فندقية', icon: 'fa-bed' },
            { id: 'suite', name: 'جناح فاخر', icon: 'fa-crown' },
            { id: 'presidential', name: 'جناح رئاسي', icon: 'fa-star' },
            { id: 'meeting', name: 'قاعة اجتماعات', icon: 'fa-users' }
          ],
          defaults: ['room', 'suite']
        },
        apartment: {
          available: [
            { id: 'studio', name: 'استوديو', icon: 'fa-door-open' },
            { id: 'apt', name: 'شقة عائلية', icon: 'fa-home' },
            { id: 'penthouse', name: 'بنتهاوس', icon: 'fa-building' }
          ],
          defaults: ['studio', 'apt']
        },
        hospital: {
          available: [
            { id: 'patient', name: 'غرفة مرضى', icon: 'fa-procedures' },
            { id: 'icu', name: 'عناية مركزة', icon: 'fa-heartbeat' },
            { id: 'lab', name: 'مختبر', icon: 'fa-flask' },
            { id: 'surgery', name: 'غرفة عمليات', icon: 'fa-user-md' }
          ],
          defaults: ['patient', 'lab']
        },
        commercial: {
          available: [
            { id: 'shop', name: 'محل تجاري', icon: 'fa-store' },
            { id: 'office', name: 'مكتب', icon: 'fa-building' },
            { id: 'warehouse', name: 'مستودع', icon: 'fa-warehouse' }
          ],
          defaults: ['shop', 'office']
        },
        custom: {
          available: [
            { id: 'custom1', name: 'نوع مخصص 1', icon: 'fa-cog' },
            { id: 'custom2', name: 'نوع مخصص 2', icon: 'fa-cogs' }
          ],
          defaults: []
        }
      };
      
      const data = catalogData[catalog] || catalogData.tower;
      
      // Render available unit types
      $('availableUnitTypes').innerHTML = data.available.map(type => `
        <div class="p-3 bg-gray-50 rounded-xl border border-gray-200 cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition text-center" 
             onclick="selectUnitType('${type.id}', '${type.name}', '${type.icon}')">
          <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-2 text-blue-600">
            <i class="fas ${type.icon}"></i>
          </div>
          <p class="text-sm font-medium text-gray-800">${type.name}</p>
        </div>
      `).join('');
      
      // Load defaults as selected
      $('selectedUnitTypes').innerHTML = '';
      data.defaults.forEach(typeId => {
        const type = data.available.find(t => t.id === typeId);
        if (type) addUnitTypeToSelected(type.id, type.name);
      });
      
      // Initialize floor selector
      updateUnitFloorsSelector();
    }
    
    function selectUnitType(id, name, icon) {
      // Visual feedback
      const container = $('availableUnitTypes');
      container.querySelectorAll('div').forEach(el => el.style.borderColor = '');
      event.currentTarget.style.borderColor = '#3b82f6';
      
      // Pre-fill form
      $('unitTypeName').value = name;
      $('unitTypeCode').value = name.toUpperCase().replace(/\s+/g, '-').slice(0, 20);
    }
    
    function updateUnitFloorsSelector() {
      const floors = AppState.session.project.buildings[0]?.floors || 12;
      $('unitFloorsSelector').innerHTML = Array.from({length: Math.min(floors, 8)}, (_, i) => `
        <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
          <input type="checkbox" ${i < 3 ? 'checked' : ''} class="rounded text-blue-600"> ${i === 0 ? 'أرضي' : i}
        </label>
      `).join('') + `<button type="button" class="text-blue-600 text-sm hover:underline">+ المزيد</button>`;
    }
    
    function addUnitType() {
      const name = $('unitTypeName').value;
      const code = $('unitTypeCode').value;
      if (!name || !code) {
        showNotification('يرجى إدخال اسم ورمز لنوع الوحدة', 'error');
        return;
      }
      
      addUnitTypeToSelected(generateId('ut'), name, code);
      $('unitTypeName').value = '';
      $('unitTypeCode').value = '';
      showNotification('تمت إضافة نوع الوحدة: ' + name, 'success');
    }
    
    function addUnitTypeToSelected(id, name, code = '') {
      const container = $('selectedUnitTypes');
      if (container.querySelector('.text-center')) container.innerHTML = '';
      
      const item = document.createElement('div');
      item.className = 'p-3 bg-blue-50 rounded-xl border border-blue-100 flex items-center justify-between';
      item.innerHTML = `
        <div>
          <p class="font-medium text-gray-800">${name}</p>
          <p class="text-xs text-gray-600">${code || 'رمز غير محدد'}</p>
        </div>
        <button onclick="removeUnitType('${id}')" class="text-red-500 hover:text-red-700 p-1">
          <i class="fas fa-times"></i>
        </button>
      `;
      item.dataset.id = id;
      container.appendChild(item);
      
      // Update count
      $('selectedCount').textContent = `(${container.children.length})`;
    }
    
    function removeUnitType(id) {
      const item = $$(`#selectedUnitTypes [data-id="${id}"]`)[0];
      if (item) {
        item.remove();
        $('selectedCount').textContent = `(${$('#selectedUnitTypes').children.length})`;
      }
    }
    
    // Time restriction toggle
    $('unitTimeRestriction')?.addEventListener('change', (e) => {
      $('timeRestrictionFields').classList.toggle('hidden', !e.target.checked);
    });
    
    // Wizard navigation
    function nextWizardStep(step) {
      // Validate step 1
      if (currentWizardStep === 1 && !AppState.session.catalog.selected) {
        showNotification('يرجى اختيار نوع العقار أولاً', 'warning');
        return;
      }
      
      // Hide current, show next
      $(`wizardStep${currentWizardStep}`).classList.add('hidden');
      $(`wizardStep${step}`).classList.remove('hidden');
      
      // Update steps UI
      $$('.wizard-step').forEach(s => {
        const sNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (sNum < step) s.classList.add('completed');
        if (sNum === step) s.classList.add('active');
      });
      
      currentWizardStep = step;
      
      // Special handling for step 3 (device pairing)
      if (step === 3) {
        updateDeviceFloorsSelector();
      }
      
      // Special handling for step 4 (completion)
      if (step === 4) {
        $('completionProjectName').textContent = AppState.session.project.name;
        $('completionUnitCount').textContent = $('#selectedUnitTypes').children.length;
        $('completionDeviceCount').textContent = AppState.devices.length;
      }
    }
    
    function prevWizardStep(step) {
      $(`wizardStep${currentWizardStep}`).classList.add('hidden');
      $(`wizardStep${step}`).classList.remove('hidden');
      
      $$('.wizard-step').forEach(s => {
        const sNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (sNum < step) s.classList.add('completed');
        if (sNum === step) s.classList.add('active');
      });
      
      currentWizardStep = step;
    }
    
    function updateDeviceFloorsSelector() {
      const floors = AppState.session.project.buildings[0]?.floors || 12;
      $('deviceFloorsSelector').innerHTML = Array.from({length: Math.min(floors, 6)}, (_, i) => `
        <label class="flex items-center gap-1.5 text-sm bg-gray-100 px-3 py-1.5 rounded-lg cursor-pointer hover:bg-gray-200">
          <input type="checkbox" ${i < 3 ? 'checked' : ''} class="rounded text-blue-600"> ${i === 0 ? 'أرضي' : i}
        </label>
      `).join('') + `<button type="button" class="text-blue-600 text-sm hover:underline">+ المزيد</button>`;
    }
    
    function startDeviceScan() {
      const btn = $('scanBtn');
      const icon = $('scanIcon');
      const results = $('scanResults');
      
      // Start animation
      icon.className = 'fas fa-sync-alt animate-spin text-xl';
      btn.disabled = true;
      results.innerHTML = '<p class="text-center text-sm text-blue-300 py-4">جاري البحث عن الأجهزة القريبة...</p>';
      
      // Simulate scan results after 2 seconds
      setTimeout(() => {
        icon.className = 'fas fa-search text-2xl';
        btn.disabled = false;
        
        const mockDevices = [
          { id: 'dev_new_1', name: 'ELV-CTRL-NEW', type: 'متحكم مصعد', signal: -42, connection: 'Bluetooth' },
          { id: 'dev_new_2', name: 'CARD-RDR-X1', type: 'قارئ كروت', signal: -58, connection: 'USB' },
          { id: 'dev_new_3', name: 'SENSOR-MOTION', type: 'مستشعر حركة', signal: -65, connection: 'Zigbee' }
        ];
        
        results.innerHTML = mockDevices.map(dev => `
          <div class="device-item" onclick="selectDeviceForPairing('${dev.id}', '${dev.name}', '${dev.type}')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center text-blue-300">
                  <i class="fas fa-microchip"></i>
                </div>
                <div>
                  <p class="font-medium text-sm">${dev.name}</p>
                  <p class="text-xs text-gray-400">${dev.type} · ${dev.connection}</p>
                </div>
              </div>
              <span class="text-xs text-gray-400">${dev.signal} dBm</span>
            </div>
          </div>
        `).join('');
        
        showNotification('تم العثور على 3 أجهزة جديدة', 'success');
      }, 2000);
    }
    
    function selectDeviceForPairing(id, name, type) {
      // Visual selection
      $$('#scanResults .device-item').forEach(el => el.classList.remove('connected'));
      event.currentTarget.classList.add('connected');
      
      // Show config panel
      $('deviceConfigPanel').classList.add('hidden');
      $('selectedDeviceInfo').classList.remove('hidden');
      $('selectedDeviceName').textContent = name;
      
      // Store selected device
      AppState.tempPairingDevice = { id, name, type };
    }
    
    function pairDevice() {
      const elevatorName = $('deviceElevatorName').value;
      if (!elevatorName) {
        showNotification('يرجى إدخال اسم المصعد في النظام', 'error');
        return;
      }
      
      // Add to devices
      const newDevice = {
        id: AppState.tempPairingDevice?.id || generateId('dev'),
        name: $('deviceElevatorName').value,
        type: 'elevator_controller',
        connection: $('connectionType').value,
        elevatorId: generateId('e'),
        building: $('deviceBuilding').value,
        lastPing: new Date().toISOString(),
        status: 'online'
      };
      
      AppState.devices.push(newDevice);
      
      // Add corresponding elevator
      const newElevator = {
        id: newDevice.elevatorId,
        tenantId: AppState.session.project.id,
        serialNumber: 'NEW-' + Date.now(),
        manufacturer: 'Generic',
        model: 'Smart Controller',
        building: newDevice.building,
        shaft: 'NEW1',
        telemetry: { status: 'online', currentFloor: 0, direction: 'idle', loadPercent: 0, lastPing: new Date().toISOString(), signalStrength: -40 },
        maintenance: { totalTrips: 0, lastService: new Date().toISOString() },
        meta: { createdAt: new Date().toISOString(), tags: ['new', 'paired'] }
      };
      
      AppState.elevators.push(newElevator);
      
      showNotification('تم ربط الجهاز وإضافة المصعد بنجاح!', 'success');
      closeModal('pairDeviceModal');
      refreshAll();
    }
    
    function skipDeviceSetup() {
      showNotification('يمكنك ربط الأجهزة لاحقاً من قسم "الأجهزة"', 'info');
      nextWizardStep(4);
    }
    
    function completeOnboarding() {
      // Save catalog configuration
      const selectedTypes = Array.from($$('#selectedUnitTypes > div')).map(el => {
        const name = el.querySelector('p.font-medium').textContent;
        const code = el.querySelector('p.text-xs').textContent.replace('رمز غير محدد', '').trim();
        return { id: el.dataset.id, name, code };
      });
      
      AppState.session.catalog.unitTypes = selectedTypes;
      AppState.session.onboardingComplete = true;
      
      // Show completion step
      nextWizardStep(4);
    }
    
    function enterMainApp() {
      $('onboardingWizard').classList.add('hidden');
      $('mainApp').classList.remove('hidden');
      $('projectName').textContent = AppState.session.project.name;
      $('projectType').textContent = {tower:'أبراج سكنية', hotel:'فنادق', apartment:'شقق مفروشة', hospital:'مستشفيات', commercial:'مجمعات تجارية', custom:'مخصص'}[AppState.session.catalog.selected] || 'مخصص';
      
      refreshAll();
      showNotification('مرحباً بك في يمنتكس برو! نظامك جاهز للاستخدام', 'success');
    }
    
    // =====================================================
    // 5. Render Functions (Pro Version)
    // =====================================================
    function renderStatCard(title, value, icon, color, trend = null, subtext = '') {
      const trendHtml = trend ? `<p class="text-xs text-${trend > 0 ? 'green' : 'red'}-600 font-semibold mt-1"><i class="fas fa-${trend > 0 ? 'arrow-up' : 'arrow-down'} ml-1"></i>${Math.abs(trend)}% عن الأمس</p>` : '';
      return `
        <div class="glass-card rounded-2xl p-5">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-gray-500 text-sm font-medium">${title}</p>
              <p class="text-3xl font-black text-gray-800 mt-1">${value}</p>
              ${trendHtml}
              ${subtext ? `<p class="text-xs text-gray-400 mt-2 font-medium">${subtext}</p>` : ''}
            </div>
            <div class="w-14 h-14 bg-${color}-100 rounded-2xl flex items-center justify-center text-${color}-600 text-2xl flex-shrink-0 shadow-sm">
              <i class="fas fa-${icon}"></i>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderElevatorCard(e) {
      const statusMap = { 
        online: { class: 'badge-online', text: 'نشط', icon: 'check-circle' },
        maintenance: { class: 'badge-maintenance', text: 'صيانة', icon: 'tools' },
        offline: { class: 'badge-offline', text: 'متوقف', icon: 'times-circle' },
        emergency: { class: 'badge-emergency', text: 'طوارئ', icon: 'exclamation-triangle' }
      };
      const status = statusMap[e.telemetry.status] || statusMap.offline;
      
      return `
        <div class="glass-card rounded-2xl p-5 relative overflow-hidden" data-id="${e.id}">
          <div class="absolute top-0 left-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-purple-500/10 rounded-full blur-2xl"></div>
          <div class="relative">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                  <i class="fas fa-elevator text-2xl"></i>
                </div>
                <div>
                  <h4 class="font-black text-gray-800">${e.specs?.capacity} كجم · ${e.specs?.speed} م/ث</h4>
                  <p class="text-sm text-gray-600 font-medium">${e.building} · ${e.shaft}</p>
                </div>
              </div>
              <span class="badge ${status.class}"><i class="fas fa-${status.icon} ml-1"></i>${status.text}</span>
            </div>
            
            <div class="grid grid-cols-3 gap-3 text-sm mb-4">
              <div class="text-center p-2.5 bg-gray-50 rounded-xl">
                <p class="text-gray-500 text-xs font-medium">الطابق</p>
                <p class="font-black text-lg text-gray-800">${e.telemetry.currentFloor}</p>
              </div>
              <div class="text-center p-2.5 bg-gray-50 rounded-xl">
                <p class="text-gray-500 text-xs font-medium">الرحلات</p>
                <p class="font-black text-lg text-gray-800">${formatNumber(e.maintenance?.totalTrips || 0)}</p>
              </div>
              <div class="text-center p-2.5 bg-gray-50 rounded-xl">
                <p class="text-gray-500 text-xs font-medium">الحمل</p>
                <p class="font-black text-lg text-gray-800">${e.telemetry.loadPercent}%</p>
              </div>
            </div>
            
            ${e.telemetry.status === 'maintenance' && e.maintenance?.maintenanceProgress ? `
              <div class="mb-3">
                <div class="flex justify-between text-xs text-gray-600 font-medium mb-1">
                  <span>تقدم الصيانة</span>
                  <span>${e.maintenance.maintenanceProgress}%</span>
                </div>
                <div class="progress"><div class="progress-fill yellow" style="width: ${e.maintenance.maintenanceProgress}%"></div></div>
              </div>
            ` : ''}
            
            <div class="flex items-center justify-between text-xs text-gray-500 pt-3 border-t border-gray-100">
              <span><i class="fas fa-wifi ml-1"></i> ${e.telemetry.signalStrength > -70 ? 'ممتاز' : e.telemetry.signalStrength > -85 ? 'جيد' : 'ضعيف'}</span>
              <span>آخر تحديث: ${getTimeAgo(e.telemetry.lastPing)}</span>
            </div>
            
            <div class="mt-4 flex gap-2">
              <button onclick="viewElevatorDetails('${e.id}')" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded-xl text-sm font-medium transition">تفاصيل</button>
              <button onclick="controlElevator('${e.id}')" class="flex-1 bg-purple-50 hover:bg-purple-100 text-purple-700 py-2 rounded-xl text-sm font-medium transition">تحكم</button>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderCardRow(c) {
      const statusMap = {
        active: { class: 'badge-online', text: 'نشط' },
        expired: { class: 'badge-warning', text: 'منتهي' },
        blocked: { class: 'badge-danger', text: 'محظور' },
        suspended: { class: 'badge-offline', text: 'معلق' },
        lost: { class: 'badge-danger', text: 'مفقود' }
      };
      const status = statusMap[c.status] || statusMap.active;
      const daysLeft = c.permissions?.validUntil ? Math.ceil((new Date(c.permissions.validUntil) - new Date()) / (1000*60*60*24)) : 0;
      
      return `
        <tr class="hover:bg-gray-50 transition">
          <td>
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-black">
                ${c.cardNumber.slice(-4)}
              </div>
              <div>
                <p class="font-bold text-gray-800">${c.cardNumber}</p>
                <p class="text-xs text-gray-500">UID: ${c.uid?.slice(0,8)}...</p>
              </div>
            </div>
          </td>
          <td>
            <p class="font-bold">${c.holder.name}</p>
            <p class="text-xs text-gray-500 font-medium">${c.holder.type}</p>
          </td>
          <td>
            <p class="text-sm font-medium">${c.holder.phone || '-'}</p>
            <p class="text-xs text-gray-500">${c.permissions?.buildings?.[0] || '-'}</p>
          </td>
          <td>
            <span class="text-xs bg-gray-100 px-2 py-1 rounded font-medium">${c.permissions?.floors?.slice(0,3).join(',')}${c.permissions?.floors?.length > 3 ? '...' : ''}</span>
          </td>
          <td>
            ${c.wallet?.balance !== undefined ? `<p class="font-bold">${c.wallet.balance} ريال</p>` : ''}
            <p class="text-xs ${daysLeft < 7 ? 'text-red-600 font-semibold' : 'text-gray-500'}">
              ${daysLeft > 0 ? `${daysLeft} يوم متبقي` : 'منتهي'}
            </p>
          </td>
          <td><span class="badge ${status.class}">${status.text}</span></td>
          <td>${getTimeAgo(c.security?.lastUsedAt)}</td>
          <td>
            <div class="flex items-center gap-1">
              <button onclick="editCard('${c.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="تعديل"><i class="fas fa-edit"></i></button>
              <button onclick="chargeCard('${c.id}')" class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition" title="شحن"><i class="fas fa-coins"></i></button>
              <button onclick="toggleCardStatus('${c.id}')" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition" title="المزيد"><i class="fas fa-ellipsis-v"></i></button>
            </div>
          </td>
        </tr>
      `;
    }
    
    function renderActivityItem(a) {
      return `
        <div class="flex items-center justify-between p-3 bg-white/80 rounded-xl hover:bg-white transition">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-${a.bg}-100 rounded-lg flex items-center justify-center text-${a.bg}-600 flex-shrink-0">
              <i class="fas fa-${a.icon}"></i>
            </div>
            <div>
              <p class="text-sm font-bold text-gray-800">${a.user}</p>
              <p class="text-xs text-gray-600">${a.action}</p>
            </div>
          </div>
          <div class="text-right">
            <span class="text-xs text-gray-400 font-medium">${a.time}</span>
            ${a.denied ? '<span class="block text-xs text-red-500 font-semibold mt-0.5">مرفوض</span>' : ''}
          </div>
        </div>
      `;
    }
    
    // =====================================================
    // 6. Refresh Functions
    // =====================================================
    function refreshDashboard() {
      const stats = {
        totalElevators: AppState.elevators.length,
        activeElevators: AppState.elevators.filter(e => e.telemetry.status === 'online').length,
        totalCards: AppState.cards.length,
        activeCards: AppState.cards.filter(c => c.status === 'active').length,
        pendingAlerts: 3,
        maintenanceDue: 2
      };
      
      $('dashboardStats').innerHTML = 
        renderStatCard('إجمالي المصاعد', stats.totalElevators, 'elevator', 'blue', null, `${stats.activeElevators} نشط حاليًا`) +
        renderStatCard('الكروت النشطة', stats.activeCards, 'id-card', 'green', 5, `من أصل ${stats.totalCards} كرت`) +
        renderStatCard('تنبيهات نشطة', stats.pendingAlerts, 'bell', 'orange', null, '1 عالي الخطورة') +
        renderStatCard('صيانة مجدولة', stats.maintenanceDue, 'calendar-check', 'purple', null, 'خلال 7 أيام');
      
      // Live elevator status
      $('elevatorStatusList').innerHTML = AppState.elevators.map(e => {
        const statusMap = { online: 'badge-online', maintenance: 'badge-maintenance', offline: 'badge-offline' };
        const statusText = { online: 'نشط', maintenance: 'صيانة', offline: 'متوقف' };
        return `
          <div class="bg-white/90 rounded-xl p-4 flex items-center justify-between hover:bg-white transition">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-elevator text-gray-600"></i>
              </div>
              <div>
                <p class="font-bold text-gray-800">${e.building} - ${e.shaft}</p>
                <p class="text-xs text-gray-500">طابق: ${e.telemetry.currentFloor} · حمل: ${e.telemetry.loadPercent}%</p>
              </div>
            </div>
            <div class="text-right">
              <span class="badge ${statusMap[e.telemetry.status]}">${statusText[e.telemetry.status]}</span>
              <p class="text-xs text-gray-400 mt-1 font-medium">${getTimeAgo(e.telemetry.lastPing)}</p>
            </div>
          </div>
        `;
      }).join('');
      
      // Recent activities
      $('recentActivities').innerHTML = AppState.recentActivities.map(renderActivityItem).join('');
      
      // Update charts
      updateCharts();
    }
    
    function refreshElevatorsScreen() {
      const stats = {
        total: AppState.elevators.length,
        online: AppState.elevators.filter(e => e.telemetry.status === 'online').length,
        maintenance: AppState.elevators.filter(e => e.telemetry.status === 'maintenance').length,
        offline: AppState.elevators.filter(e => e.telemetry.status === 'offline').length
      };
      
      $('elevatorStatsCards').innerHTML = `
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-blue-600">${stats.total}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">إجمالي المصاعد</p>
        </div>
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-green-600">${stats.online}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">نشط</p>
        </div>
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-yellow-600">${stats.maintenance}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">في صيانة</p>
        </div>
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-gray-600">${stats.offline}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">متوقف</p>
        </div>
      `;
      
      filterElevators();
    }
    
    function refreshCardsScreen() {
      const stats = {
        total: AppState.cards.length,
        active: AppState.cards.filter(c => c.status === 'active').length,
        expired: AppState.cards.filter(c => c.status === 'expired').length,
        blocked: AppState.cards.filter(c => c.status === 'blocked').length
      };
      
      $('cardStatsCards').innerHTML = `
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-blue-600">${stats.total}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">إجمالي الكروت</p>
        </div>
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-green-600">${stats.active}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">نشط</p>
        </div>
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-yellow-600">${stats.expired}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">منتهي</p>
        </div>
        <div class="glass-card p-4 text-center rounded-xl">
          <span class="text-2xl font-black text-red-600">${stats.blocked}</span>
          <p class="text-xs text-gray-600 mt-1 font-medium">محظور</p>
        </div>
      `;
      
      filterCards();
    }
    
    function refreshAll() {
      // Update sidebar counts
      $('elevatorCount').textContent = AppState.elevators.length;
      $('cardCount').textContent = AppState.cards.length;
      
      // Update project info
      $('projectName').textContent = AppState.session.project.name;
      $('userName').textContent = AppState.session.userName;
      
      // Refresh active screen
      if (!$('dashboardScreen').classList.contains('hidden')) refreshDashboard();
      if (!$('elevatorsScreen').classList.contains('hidden')) refreshElevatorsScreen();
      if (!$('cardsScreen').classList.contains('hidden')) refreshCardsScreen();
      
      // Initialize property structure
      if ($('floorsList')) updateFloorsList('برج السلام');
      
      // Initialize unit types overview
      renderUnitTypesOverview();
    }
    
    // =====================================================
    // 7. Filter & Search Functions
    // =====================================================
    function filterElevators() {
      const statusFilter = $('elevatorFilter')?.value || 'all';
      const buildingFilter = $('buildingFilter')?.value || 'all';
      const manufacturerFilter = $('manufacturerFilter')?.value || 'all';
      
      let filtered = AppState.elevators;
      if (statusFilter !== 'all') filtered = filtered.filter(e => e.telemetry.status === statusFilter);
      if (buildingFilter !== 'all') filtered = filtered.filter(e => e.building === buildingFilter);
      if (manufacturerFilter !== 'all') filtered = filtered.filter(e => e.manufacturer === manufacturerFilter);
      
      $('elevatorsGrid').innerHTML = filtered.map(renderElevatorCard).join('') || 
        '<div class="col-span-full text-center py-12 text-gray-500 font-medium">لا توجد مصاعد مطابقة للفلتر</div>';
    }
    
    function filterCards() {
      const search = $('cardSearch')?.value.toLowerCase() || '';
      const statusFilter = $('cardFilter')?.value || 'all';
      const typeFilter = $('cardTypeFilter')?.value || 'all';
      
      let filtered = AppState.cards;
      if (search) {
        filtered = filtered.filter(c => 
          c.holder.name.toLowerCase().includes(search) || 
          c.cardNumber.includes(search) ||
          c.holder.phone?.includes(search)
        );
      }
      if (statusFilter !== 'all') filtered = filtered.filter(c => c.status === statusFilter);
      if (typeFilter !== 'all') filtered = filtered.filter(c => c.holder.type === typeFilter);
      
      $('cardsTableBody').innerHTML = filtered.map(renderCardRow).join('') ||
        '<tr><td colspan="8" class="text-center py-8 text-gray-500 font-medium">لا توجد كروت مطابقة للبحث</td></tr>';
    }
    
    function updateFloorsList(building) {
      $('selectedBuilding').textContent = building;
      const buildingData = AppState.session.project.buildings.find(b => b.name === building);
      const floors = buildingData?.floors || 12;
      
      $('floorsList').innerHTML = Array.from({length: floors}, (_, i) => `
        <div class="p-3 bg-white rounded-lg border border-gray-100 cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition flex items-center justify-between" onclick="selectFloor(${i})">
          <span class="font-bold text-gray-800">${i === 0 ? 'أرضي' : `طابق ${i}`}</span>
          <span class="text-xs text-gray-500 font-medium">${Math.floor(Math.random() * 8) + 2} وحدات</span>
        </div>
      `).join('');
      
      selectFloor(0);
    }
    
    function selectFloor(floorNum) {
      $('selectedFloor').textContent = floorNum === 0 ? 'أرضي' : floorNum;
      $('unitsGrid').innerHTML = Array.from({length: 6}, (_, i) => {
        const unitTypes = AppState.session.catalog.unitTypes || [];
        const randomType = unitTypes[Math.floor(Math.random() * unitTypes.length)] || { name: 'وحدة' };
        const statuses = ['شاغر', 'مشغول', 'صيانة'];
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const statusColor = status === 'مشغول' ? 'green' : status === 'صيانة' ? 'yellow' : 'gray';
        
        return `
          <div class="p-4 bg-white rounded-xl border border-gray-100 text-center cursor-pointer hover:border-blue-300 hover:shadow-md transition">
            <p class="font-bold text-gray-800">${floorNum === 0 ? 'مستقبل' : `وحدة ${floorNum}${i+1}`}</p>
            <p class="text-xs text-${statusColor}-600 font-medium mt-1">${randomType.name}</p>
            <p class="text-xs text-gray-500 mt-0.5">${status}</p>
          </div>
        `;
      }).join('');
    }
    
    function selectBuilding(building) {
      updateFloorsList(building);
    }
    
    function renderUnitTypesOverview() {
      const container = $('unitTypesOverview');
      if (!container) return;
      
      const unitTypes = AppState.session.catalog.unitTypes || [];
      if (unitTypes.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 col-span-3 py-4">لم يتم إضافة أنواع وحدات بعد</p>';
        return;
      }
      
      container.innerHTML = unitTypes.map(type => `
        <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
              <i class="fas fa-door-open"></i>
            </div>
            <div>
              <p class="font-bold text-gray-800">${type.name}</p>
              <p class="text-xs text-gray-600">${type.code || 'رمز غير محدد'}</p>
            </div>
          </div>
          <div class="flex items-center justify-between text-xs text-gray-600">
            <span><i class="fas fa-layer-group ml-1"></i> ${type.floors?.length || 0} طوابق</span>
            <span class="badge badge-online">نشط</span>
          </div>
        </div>
      `).join('');
    }
    
    // =====================================================
    // 8. Modal Functions
    // =====================================================
    function openModal(modalId) {
      $(modalId).classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Initialize card permissions if opening card modal
      if (modalId === 'cardModal') {
        updateCardPermissions();
      }
    }
    
    function closeModal(modalId) {
      $(modalId).classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Close modal on outside click
    $$('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(modal.id);
      });
    });
    
    function updateCardPermissions() {
      const type = $('cardHolderType')?.value || 'نزيل';
      const container = $('cardFloorsContainer');
      if (!container) return;
      
      let floors = [];
      if (type === 'نزيل' || type === 'مستأجر') floors = [10, 11, 12];
      else if (type === 'موظف') floors = [0,1,2,3,4,5,6,7,8,9,10];
      else if (type === 'مقاول' || type === 'زائر') floors = [0, 1];
      else if (type === 'طبيب') floors = [0,1,2,3,4,5,6,7,8];
      
      container.innerHTML = floors.map(f => `
        <label class="flex items-center gap-1.5 text-sm bg-white px-3 py-1.5 rounded-lg border cursor-pointer hover:border-blue-300">
          <input type="checkbox" checked class="rounded text-blue-600"> ${f === 0 ? 'أرضي' : f}
        </label>
      `).join('');
    }
    
    // =====================================================
    // 9. Business Action Functions
    // =====================================================
    function saveElevator() {
      showNotification('تمت إضافة المصعد بنجاح! جاري المزامنة مع الجهاز...', 'success');
      closeModal('elevatorModal');
      
      const newElevator = {
        id: generateId('e'),
        tenantId: AppState.session.project.id,
        serialNumber: 'NEW-' + Date.now(),
        manufacturer: 'Otis',
        model: 'Gen2® Comfort',
        building: 'برج السلام',
        shaft: 'NEW1',
        telemetry: { status: 'online', currentFloor: 0, direction: 'idle', loadPercent: 0, lastPing: new Date().toISOString(), signalStrength: -40 },
        maintenance: { totalTrips: 0, lastService: new Date().toISOString() },
        meta: { createdAt: new Date().toISOString(), tags: ['new'] }
      };
      AppState.elevators.push(newElevator);
      refreshAll();
    }
    
    function issueCard() {
      showNotification('تم إصدار الكرت بنجاح! جاري الطباعة والتفعيل...', 'success');
      closeModal('cardModal');
      
      const newCard = {
        id: generateId('c'),
        tenantId: AppState.session.project.id,
        cardNumber: '****' + Math.floor(1000 + Math.random() * 9000),
        uid: Array.from({length: 8}, () => Math.floor(Math.random()*16).toString(16)).join('').toUpperCase(),
        holder: { type: $('cardHolderType').value, name: 'مستخدم جديد', phone: '+9665XXXXXXXX' },
        permissions: { buildings: ['برج السلام'], floors: [1,2,3], validFrom: new Date().toISOString().split('T')[0], validUntil: '2025-12-31' },
        status: 'active',
        audit: { issuedBy: AppState.session.userId, issuedAt: new Date().toISOString() }
      };
      AppState.cards.push(newCard);
      refreshAll();
    }
    
    function scheduleMaintenance() {
      showNotification('تم جدولة مهمة الصيانة! سيتم إشعار الفني والمستخدمين...', 'success');
      closeModal('maintenanceModal');
      const current = parseInt($('pendingMaintenance').textContent) || 0;
      $('pendingMaintenance').textContent = current + 1;
    }
    
    function editCard(cardId) {
      showNotification(`جاري تعديل الكرت ${cardId}...`, 'info');
    }
    
    function chargeCard(cardId) {
      showNotification(`شحن الكرت ${cardId} بمبلغ 50 ريال`, 'success');
      const card = AppState.cards.find(c => c.id === cardId);
      if (card?.wallet) card.wallet.balance = (card.wallet.balance || 0) + 50;
      refreshCardsScreen();
    }
    
    function toggleCardStatus(cardId) {
      const card = AppState.cards.find(c => c.id === cardId);
      if (!card) return;
      const newStatus = card.status === 'active' ? 'suspended' : 'active';
      card.status = newStatus;
      showNotification(`تم ${newStatus === 'active' ? 'تفعيل' : 'تعليق'} الكرت`, 'success');
      refreshCardsScreen();
    }
    
    function viewElevatorDetails(elevatorId) {
      showNotification(`عرض تفاصيل المصعد ${elevatorId}...`, 'info');
    }
    
    function controlElevator(elevatorId) {
      showNotification(`فتح لوحة تحكم المصعد ${elevatorId}...`, 'info');
    }
    
    function exportCards(format) {
      showNotification(`جاري تصدير الكروت بصيغة ${format.toUpperCase()}...`, 'info');
      setTimeout(() => {
        showNotification('تم تحميل الملف بنجاح!', 'success');
      }, 1500);
    }
    
    function generateReport(type) {
      showNotification(`جاري إنشاء تقرير ${type === 'full' ? 'شامل' : 'يومي'}...`, 'info');
      setTimeout(() => {
        showNotification('تم إنشاء التقرير! جاري التحميل...', 'success');
      }, 2000);
    }
    
    function generateQuickReport() {
      showNotification('جاري إنشاء تقرير سريع...','info');
      setTimeout(() => {
        showNotification('تم إنشاء التقرير السريع!','success');
      },1000);
    }
    
    function triggerEmergency() {
      if (!confirm('⚠️ تحذير أمني: تفعيل حالة الطوارئ سيوقف جميع المصاعد ويفتح الأبواب تلقائياً. هل أنت متأكد تماماً؟')) return;
      
      showNotification('🚨 تم تفعيل بروتوكول الطوارئ المؤسسي! جاري إيقاف المصاعد...', 'error');
      
      // Simulate emergency protocol
      AppState.elevators.forEach(e => {
        if (e.telemetry.status === 'online') {
          e.telemetry.status = 'emergency';
          e.telemetry.doorState = 'open';
        }
      });
      
      // Log to audit
      AppState.auditLogs.unshift({
        id: generateId('log'),
        actor: { userId: AppState.session.userId, role: 'admin' },
        action: 'emergency_activated',
        resource: { type: 'system', id: 'all' },
        details: { reason: 'manual_trigger' },
        outcome: 'success',
        timestamp: new Date().toISOString()
      });
      
      setTimeout(() => {
        showNotification('تم إشعار الدفاع المدني وفرق الطوارئ والمديرين', 'warning');
        refreshAll();
      }, 2500);
    }
    
    function confirmPairDevice() {
      if (!AppState.tempPairingDevice) {
        showNotification('يرجى اختيار جهاز أولاً', 'warning');
        return;
      }
      pairDevice();
      closeModal('pairDeviceModal');
    }
    
    // =====================================================
    // 10. Notification System
    // =====================================================
    function showNotification(message, type = 'success') {
      const container = $('notificationContainer');
      const notif = document.createElement('div');
      notif.className = `notification ${type} scale-in`;
      notif.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} text-xl"></i>
        <span class="font-medium">${message}</span>
      `;
      container.appendChild(notif);
      
      // Show with animation
      setTimeout(() => notif.classList.add('show'), 100);
      
      // Auto-hide after 4 seconds
      setTimeout(() => {
        notif.classList.remove('show');
        setTimeout(() => notif.remove(), 300);
      }, 4000);
    }
    
    // =====================================================
    // 11. Charts (Chart.js)
    // =====================================================
    let usageChart, cardsChart, floorChart, peakChart;
    
    function updateCharts() {
      // Usage Chart
      const usageCtx = $('usageChart')?.getContext('2d');
      if (usageCtx) {
        if (usageChart) usageChart.destroy();
        usageChart = new Chart(usageCtx, {
          type: 'line',
           {
            labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
            datasets: [{
              label: 'عدد الرحلات',
               [12, 19, 45, 78, 92, 65, 30],
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.4,
              borderWidth: 3,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 } } },
              x: { grid: { display: false }, ticks: { font: { size: 10 } } }
            },
            interaction: { mode: 'index', intersect: false }
          }
        });
      }
      
      // Cards Chart
      const cardsCtx = $('cardsChart')?.getContext('2d');
      if (cardsCtx) {
        if (cardsChart) cardsChart.destroy();
        cardsChart = new Chart(cardsCtx, {
          type: 'doughnut',
           {
            labels: ['نشط', 'منتهي', 'محظور', 'معلق'],
            datasets: [{
               [3, 1, 1, 0],
              backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280'],
              borderWidth: 0,
              hoverOffset: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { usePointStyle: true, font: { size: 10 } } }
            },
            cutout: '70%'
          }
        });
      }
      
      // Floor Usage Chart
      const floorCtx = $('floorUsageChart')?.getContext('2d');
      if (floorCtx) {
        if (floorChart) floorChart.destroy();
        floorChart = new Chart(floorCtx, {
          type: 'bar',
           {
            labels: ['أرضي', '1', '2', '3', '4', '5', '6+', 'مطاعم'],
            datasets: [{
              label: 'عدد الزيارات',
               [145, 89, 112, 67, 45, 234, 178, 98],
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              borderRadius: 8,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 } } },
              x: { grid: { display: false }, ticks: { font: { size: 10 } } }
            }
          }
        });
      }
      
      // Peak Hours Chart
      const peakCtx = $('peakHoursChart')?.getContext('2d');
      if (peakCtx) {
        if (peakChart) peakChart.destroy();
        peakChart = new Chart(peakCtx, {
          type: 'line',
           {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
              label: 'متوسط الانتظار (ثانية)',
               [12, 15, 22, 18, 14, 10, 8, 15, 35, 42, 38, 25, 20, 18, 22, 28, 45, 52, 48, 35, 28, 22, 18, 14],
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              fill: true,
              tension: 0.3,
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 10 } } },
              x: { grid: { display: false }, ticks: { font: { size: 9 } } }
            }
          }
        });
      }
    }
    
    // =====================================================
    // 12. Navigation & UI Management
    // =====================================================
    let currentScreen = 'dashboard';
    
    function navigate(screen) {
      // Hide all screens
      ['dashboard','elevators','cards','property','units','maintenance','alerts','reports','team','devices','settings'].forEach(s => {
        $(s + 'Screen')?.classList.add('hidden');
      });
      
      // Show target screen
      $(screen + 'Screen')?.classList.remove('hidden');
      
      // Update sidebar active state
      $$('.sidebar-item').forEach(el => el.classList.remove('active'));
      $('nav' + screen.charAt(0).toUpperCase() + screen.slice(1))?.classList.add('active');
      
      // Update page titles
      const titles = {
        dashboard: 'لوحة التحكم', elevators: 'المصاعد', cards: 'بطاقات الوصول',
        property: 'هيكل العقار', units: 'الوحدات والسكان', maintenance: 'الصيانة',
        alerts: 'التنبيهات', reports: 'التقارير', team: 'الفريق', devices: 'الأجهزة', settings: 'الإعدادات'
      };
      $('pageTitle').textContent = titles[screen] || 'يمنتكس برو';
      $('pageSubtitle').textContent = {
        dashboard: 'نظرة شاملة على نظام إدارة المصاعد',
        elevators: 'إدارة ومراقبة المصاعد والأجهزة',
        cards: 'إصدار وإدارة بطاقات الوصول',
        property: 'هيكل المباني والطوابق والوحدات',
        units: 'إدارة الوحدات والمقيمين والصلاحيات',
        maintenance: 'جدولة ومتابعة مهام الصيانة',
        alerts: 'مركز التنبيهات والإنذارات الفورية',
        reports: 'تحليلات وتقارير أداء النظام',
        team: 'إدارة أعضاء الفريق والصلاحيات',
        devices: 'إدارة الأجهزة وبروتوكولات الاتصال',
        settings: 'تكوين إعدادات النظام والعقار'
      }[screen];
      
      currentScreen = screen;
      
      // Refresh screen content
      if (screen === 'dashboard') refreshDashboard();
      else if (screen === 'elevators') refreshElevatorsScreen();
      else if (screen === 'cards') refreshCardsScreen();
      
      // Close mobile menu if open
      if (window.innerWidth < 1024) {
        $('sidebar').classList.remove('active');
        $('mobileOverlay').classList.remove('active');
      }
    }
    
    function logout() {
      if (confirm('هل تريد تسجيل الخروج من يمنتكس برو؟')) {
        $('mainApp').classList.add('hidden');
        $('authScreen').classList.remove('hidden');
        showNotification('تم تسجيل الخروج بنجاح', 'info');
      }
    }
    
    // Quick Actions Dropdown
    $('quickActionsBtn')?.addEventListener('click', () => {
      $('quickActionsMenu').classList.toggle('hidden');
    });
    
    // Close quick actions when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#quickActionsBtn') && !e.target.closest('#quickActionsMenu')) {
        $('quickActionsMenu')?.classList.add('hidden');
      }
    });
    
    // Sidebar collapse (desktop)
    $('collapseSidebar')?.addEventListener('click', () => {
      const sidebar = $('sidebar');
      const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
      sidebar.classList.toggle('sidebar-collapsed');
      $('collapseSidebar').innerHTML = isCollapsed ? 
        '<i class="fas fa-chevron-right text-lg"></i>' : 
        '<i class="fas fa-chevron-left text-lg"></i>';
    });
    
    // Mobile menu
    $('mobileMenuBtn')?.addEventListener('click', () => {
      $('sidebar').classList.add('active');
      $('mobileOverlay').classList.add('active');
    });
    
    $('mobileOverlay')?.addEventListener('click', () => {
      $('sidebar').classList.remove('active');
      $('mobileOverlay').classList.remove('active');
    });
    
    // Global search
    $('globalSearch')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      if (query.length > 2) {
        // Simple search simulation
        showNotification(`جاري البحث عن: "${query}"`, 'info');
      }
    });
    
    // =====================================================
    // 13. Initialization & Real-time Simulation
    // =====================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize card permissions
      updateCardPermissions();
      
      // Initialize filters
      $('cardSearch')?.addEventListener('input', filterCards);
      $('cardFilter')?.addEventListener('change', filterCards);
      $('cardTypeFilter')?.addEventListener('change', filterCards);
      $('elevatorFilter')?.addEventListener('change', filterElevators);
      $('buildingFilter')?.addEventListener('change', filterElevators);
      $('manufacturerFilter')?.addEventListener('change', filterElevators);
      
      // Initialize property structure
      updateFloorsList('برج السلام');
      
      // Initialize unit types
      if ($('availableUnitTypes')) loadUnitTypesForCatalog('tower');
      
      // Show welcome notification if on main app
      if (!$('authScreen').classList.contains('hidden') && !$('onboardingWizard').classList.contains('hidden')) {
        setTimeout(() => {
          showNotification('نظام يمنتكس برو جاهز · ابدأ بإعداد مشروعك', 'info');
        }, 1000);
      }
    });
    
    // Real-time simulation (every 10 seconds)
    setInterval(() => {
      if (!$('mainApp').classList.contains('hidden')) {
        // Update random elevator floor
        const onlineElevators = AppState.elevators.filter(e => e.telemetry.status === 'online');
        if (onlineElevators.length > 0) {
          const e = onlineElevators[Math.floor(Math.random() * onlineElevators.length)];
          e.telemetry.currentFloor = Math.floor(Math.random() * 12);
          e.telemetry.loadPercent = Math.floor(Math.random() * 100);
          e.telemetry.lastPing = new Date().toISOString();
        }
        
        // Update last update time
        if (!$('dashboardScreen').classList.contains('hidden')) {
          $('lastUpdate').textContent = 'الآن';
        }
        
        // Refresh visible charts
        if (!$('dashboardScreen').classList.contains('hidden') || !$('reportsScreen').classList.contains('hidden')) {
          updateCharts();
        }
        
        // Refresh visible screens
        if (!$('elevatorsScreen').classList.contains('hidden')) filterElevators();
        if (!$('cardsScreen').classList.contains('hidden')) filterCards();
      }
    }, 10000);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close any open modal
        $$('.modal.active').forEach(modal => closeModal(modal.id));
        // Close quick actions
        $('quickActionsMenu')?.classList.add('hidden');
      }
      if (e.key === 'd' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        navigate('dashboard');
      }
      if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        navigate('elevators');
      }
      if (e.key === 'c' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        navigate('cards');
      }
    });
    
    // Prevent default on anchor links
    document.addEventListener('click', (e) => {
      if (e.target.closest('a[href="#"]')) {
        e.preventDefault();
      }
    });
  </script>
</body>
            </html>
